<!DOCTYPE html>






  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="六个月前写买好车搜索的Elasticsearch实践：初体验这篇文章的时候，我司刚刚迁移到Elasticserach，六个月之后的今天跟我最开始什么都不懂的时候搭起来的架构还是一模一样，这几天稍微有点时间，将Elasticsearch升级到了5.0.2，顺便整理了一下架构。这一篇主要记录搜索与数据库同步的一些变化。">
<meta name="keywords" content="elasticsearch,logstash">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL到Elasticsearch的同步之路">
<meta property="og:url" content="https://suclogger.me/MySQL到Elasticsearch的同步之路/index.html">
<meta property="og:site_name" content="Suclogger">
<meta property="og:description" content="六个月前写买好车搜索的Elasticsearch实践：初体验这篇文章的时候，我司刚刚迁移到Elasticserach，六个月之后的今天跟我最开始什么都不懂的时候搭起来的架构还是一模一样，这几天稍微有点时间，将Elasticsearch升级到了5.0.2，顺便整理了一下架构。这一篇主要记录搜索与数据库同步的一些变化。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://suclogger.me/image/2016-12-11-13-39-47.jpg">
<meta property="og:image" content="https://suclogger.me/image/2016-12-11-15-02-39.jpg">
<meta property="og:image" content="https://suclogger.me/image/2016-12-11-15-00-03.jpg">
<meta property="og:updated_time" content="2017-09-28T10:46:30.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL到Elasticsearch的同步之路">
<meta name="twitter:description" content="六个月前写买好车搜索的Elasticsearch实践：初体验这篇文章的时候，我司刚刚迁移到Elasticserach，六个月之后的今天跟我最开始什么都不懂的时候搭起来的架构还是一模一样，这几天稍微有点时间，将Elasticsearch升级到了5.0.2，顺便整理了一下架构。这一篇主要记录搜索与数据库同步的一些变化。">
<meta name="twitter:image" content="https://suclogger.me/image/2016-12-11-13-39-47.jpg">






  <link rel="canonical" href="https://suclogger.me/MySQL到Elasticsearch的同步之路/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>MySQL到Elasticsearch的同步之路 | Suclogger</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Suclogger</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">莆放</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">Archives</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories" rel="section">Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about" rel="section">About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">
    <a href="/sitemap.xml" rel="section">Sitemap</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://suclogger.me/MySQL到Elasticsearch的同步之路/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Suclogger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Suclogger">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">MySQL到Elasticsearch的同步之路
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-12-11 13:25:50" itemprop="dateCreated datePublished" datetime="2016-12-11T13:25:50+08:00">2016-12-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2017-09-28 18:46:30" itemprop="dateModified" datetime="2017-09-28T18:46:30+08:00">2017-09-28</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/搜索/" itemprop="url" rel="index"><span itemprop="name">搜索</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/MySQL到Elasticsearch的同步之路/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="MySQL到Elasticsearch的同步之路/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>六个月前写<a href="http://suclogger.me/%E4%B9%B0%E5%A5%BD%E8%BD%A6%E6%90%9C%E7%B4%A2%E7%9A%84Elasticsearch%E5%AE%9E%E8%B7%B5%EF%BC%9A%E5%88%9D%E4%BD%93%E9%AA%8C/">买好车搜索的Elasticsearch实践：初体验</a>这篇文章的时候，我司刚刚迁移到Elasticserach，六个月之后的今天跟我最开始什么都不懂的时候搭起来的架构还是一模一样，这几天稍微有点时间，将Elasticsearch升级到了5.0.2，顺便整理了一下架构。<br>这一篇主要记录搜索与数据库同步的一些变化。<br><a id="more"></a></p>
<h2 id="洪荒时代"><a href="#洪荒时代" class="headerlink" title="洪荒时代"></a>洪荒时代</h2><p>Elasticsearch 2.0 之前，同步数据到Elasticsearch的功能由一个官方提供的插件（plugin）占领：river。通过实现不同的river插件，可以将数据从数据库，消息队列，nosql等等同步到Elasticsearch中，比如：<a href="https://github.com/elastic/elasticsearch-river-rabbitmq" target="_blank" rel="noopener">elasticsearch-river-rabbitmq</a>、<a href="https://github.com/elastic/elasticsearch-river-couchdb" target="_blank" rel="noopener">elasticsearch-river-couchdb</a>等等。<br>以plugin方式运行的形式如图：<br><img src="/image/2016-12-11-13-39-47.jpg" alt=""><br>可以看到，插件与Elasticsearch运行在同一个jvm上，显然这会导致一系列的问题，正如<a href="https://www.elastic.co/blog/deprecating-rivers" target="_blank" rel="noopener">Deprecating Rivers</a>中所说：</p>
<blockquote>
<p>What was the problem we were witnessing? Cluster stability. You see, by their nature, rivers deal with external systems, and those external systems require external libraries to work with. Those are great to use, but they come with an overhead. Part of it is built in overhead, things like additional memory usage, more sockets, file descriptors and so on. Others, sadly, are bugs.</p>
</blockquote>
<p>插件的运行机制将外部数据和其他运行库的不稳定性引入了Elasticsearch，所以Elasticsearch官方从 Elasticsearch 2.0 开始去除了这一方式的支持，转而推荐<code>getting data to Elasticsearch from &quot;outside&quot; the cluster</code>即从集群外部将数据导入Elasticsearch的方式。</p>
<h2 id="Elasticsearch-JDBC"><a href="#Elasticsearch-JDBC" class="headerlink" title="Elasticsearch-JDBC"></a>Elasticsearch-JDBC</h2><p><a href="https://github.com/jprante/elasticsearch-jdbc" target="_blank" rel="noopener">elasticsearch-jdbc</a>无疑是Elasticsearch 5.0 之前最炙手可热的数据库同步方案，他的优势是开源，用java语言编写，配置化。这也是我司最早时候采用的方案。<br>Elasticsearch-JDBC不可否认也存在一些不足，主要有：</p>
<h3 id="不支持多数据源"><a href="#不支持多数据源" class="headerlink" title="不支持多数据源"></a>不支持多数据源</h3><p>需要对源代码做一些hack</p>
<h3 id="SQL以json形式保存，因此不能带有特殊字符"><a href="#SQL以json形式保存，因此不能带有特殊字符" class="headerlink" title="SQL以json形式保存，因此不能带有特殊字符"></a>SQL以json形式保存，因此不能带有特殊字符</h3><p>比如有一句SQL：<code>select replace(columnA, &#39;.&#39; ,&#39;&#39; ) from dual</code>，需要改造成基于ASCII编码的格式：<code>select replace(columnA, 0x2E, &#39;&#39;) from dual</code></p>
<h3 id="内存泄露问题"><a href="#内存泄露问题" class="headerlink" title="内存泄露问题"></a>内存泄露问题</h3><p>Elasticsearch-JDBC在使用过程中会出现OOM的问题，特别是在<code>interval</code>设得很短的时候，解决的方式可以参考这个<a href="https://github.com/jprante/elasticsearch-jdbc/issues/842" target="_blank" rel="noopener">issue</a>。</p>
<h3 id="数据缺失问题"><a href="#数据缺失问题" class="headerlink" title="数据缺失问题"></a>数据缺失问题</h3><p>脚本读取的是从库，主从同步需要一定时间，如果数据写入了，但是未及时同步到从库，就会导致中间一些数据丢失，可以用一个简单粗暴的方式解决，就是每次运行读取（上次执行时间 - 30S ）这个时间点之后更新的数据，这里不用考虑重复的问题，因为同样的ID在Elasticsearch中会自动转为update：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> dual <span class="keyword">where</span> <span class="keyword">time</span> &gt; <span class="keyword">date_sub</span>(?, <span class="built_in">interval</span> <span class="number">30</span> <span class="keyword">SECOND</span>)</span><br></pre></td></tr></table></figure></p>
<p>最终线上的增量同步脚本如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">DIR=<span class="string">"<span class="variable">$( cd "$( dirname "$&#123;BASH_SOURCE[0]&#125;" )</span>"</span> &amp;&amp; <span class="built_in">pwd</span> )<span class="string">"</span></span><br><span class="line"><span class="string">bin=<span class="variable">$&#123;DIR&#125;</span></span></span><br><span class="line"><span class="string">lib=<span class="variable">$&#123;DIR&#125;</span>/../../lib</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo '</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "</span><span class="built_in">type</span><span class="string">" : "</span>jdbc<span class="string">",</span></span><br><span class="line"><span class="string">    "</span>jdbc<span class="string">" : &#123;</span></span><br><span class="line"><span class="string">        "</span>url<span class="string">" : "</span>jdbc:mysql://www.maihaoche.com/<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>statefile<span class="string">" : "</span>statefile.json<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>schedule<span class="string">" : "</span>0/5 * * ? * *<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>user<span class="string">" : "</span>mhc<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>password<span class="string">" : "</span>mhc<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>sql<span class="string">" : [&#123;</span></span><br><span class="line"><span class="string">                "</span>statement<span class="string">": "</span>select * from dual <span class="built_in">where</span> modified &gt;= date_sub(?, interval 30 SECOND)<span class="string">",</span></span><br><span class="line"><span class="string">                "</span>parameter<span class="string">": ["</span><span class="variable">$metrics</span>.lastexecutionstart<span class="string">"]&#125;</span></span><br><span class="line"><span class="string">            ],</span></span><br><span class="line"><span class="string">        "</span>index<span class="string">" : "</span>*<span class="string">",</span></span><br><span class="line"><span class="string">        "</span><span class="built_in">type</span><span class="string">" : "</span>*<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>metrics<span class="string">": &#123;</span></span><br><span class="line"><span class="string">            "</span>enabled<span class="string">" : true,</span></span><br><span class="line"><span class="string">            "</span>interval<span class="string">" : "</span>1<span class="string">"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "</span>elasticsearch<span class="string">" : &#123;</span></span><br><span class="line"><span class="string">             "</span>cluster<span class="string">" : "</span>*<span class="string">",</span></span><br><span class="line"><span class="string">             "</span>host<span class="string">" : "</span>*<span class="string">",</span></span><br><span class="line"><span class="string">             "</span>port<span class="string">" : 9300</span></span><br><span class="line"><span class="string">        &#125; </span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">' | java \</span></span><br><span class="line"><span class="string">    -cp "</span><span class="variable">$&#123;lib&#125;</span>/*<span class="string">" \</span></span><br><span class="line"><span class="string">    -Dlog4j.configurationFile=<span class="variable">$&#123;bin&#125;</span>/car.xml \</span></span><br><span class="line"><span class="string">    org.xbib.tools.Runner \</span></span><br><span class="line"><span class="string">    org.xbib.tools.JDBCImporter</span></span><br></pre></td></tr></table></figure></p>
<p>虽然很简陋，但是也矜矜业业运行了半年时间没出过问题，可以作为迅速上线的一个方式。</p>
<p>同样的，作为开源软件的劣势就是很难及时跟上Elasticsearch的更新步伐，Elasticsearch-JDBC暂时还不支持Elasticsearch 5.0，具体可以跟踪这个<a href="https://github.com/jprante/elasticsearch-jdbc/issues/915" target="_blank" rel="noopener">issue</a>。</p>
<h2 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h2><h3 id="为什么不用Logstash？"><a href="#为什么不用Logstash？" class="headerlink" title="为什么不用Logstash？"></a>为什么不用Logstash？</h3><p>正如Elasticsearch-JDBC的作者@jprante 所说：</p>
<blockquote>
<p>I have only a rough idea about Logstash JDBC and how it works, it seems to use the JRuby features for JDBC. Not sure how Ruby interferes in such a process when SQL database types are mapped by JDBC types, then mapped to Java, then to Ruby, then to JSON, then indexed in ES and then back to an application, but there might be shortcomings. SQL to JDBC to Java is already a challenge on its own.</p>
</blockquote>
<p>Logstash基于Ruby语言，Logstash JDBC采用JDBC的java驱动，意味着，数据从数据库到Elasticsearch经历了JDBC -&gt; JAVA -&gt; Ruby -&gt; JSON -&gt; ES，越多的步骤意味着越多出错的概率，为何不采用更为稳定和直接的JDBC -&gt; JAVA -&gt; ES呢？这也是Elasticsearch-JDBC将会继续维护的原因。</p>
<h3 id="为什么要用Logstash呢？"><a href="#为什么要用Logstash呢？" class="headerlink" title="为什么要用Logstash呢？"></a>为什么要用Logstash呢？</h3><h4 id="支持Elasticsearch-5-0，-而且有官方支持"><a href="#支持Elasticsearch-5-0，-而且有官方支持" class="headerlink" title="支持Elasticsearch 5.0， 而且有官方支持"></a>支持Elasticsearch 5.0， 而且有官方支持</h4><h4 id="便于日后扩展输入和输出"><a href="#便于日后扩展输入和输出" class="headerlink" title="便于日后扩展输入和输出"></a>便于日后扩展输入和输出</h4><p>Logstash提供了很多很多的输入输出插件的支持</p>
<h4 id="Logstash-JDBC更快"><a href="#Logstash-JDBC更快" class="headerlink" title="Logstash JDBC更快"></a>Logstash JDBC更快</h4><p>根据我在测试环境的观察，11W条记录相同类型的索引，Elasticsearch-JDBC完成索引耗时90S，Logstash-JDBC只需要50S。</p>
<h4 id="占用系统资源更少"><a href="#占用系统资源更少" class="headerlink" title="占用系统资源更少"></a>占用系统资源更少</h4><p>根据我在测试环境的观察：<br>Elasticsearch-JDBC的系统资源使用：<br><img src="/image/2016-12-11-15-02-39.jpg" alt=""><br>Logstash-JDBC的系统资源使用：<br><img src="/image/2016-12-11-15-00-03.jpg" alt=""></p>
<h3 id="迁移到Logstash"><a href="#迁移到Logstash" class="headerlink" title="迁移到Logstash"></a>迁移到Logstash</h3><p>具体可以参考官方的文档：<a href="https://www.elastic.co/guide/en/logstash/5.0/plugins-inputs-jdbc.html" target="_blank" rel="noopener">jdbc</a><br>和官方的使用案例：<a href="https://www.elastic.co/blog/logstash-jdbc-input-plugin" target="_blank" rel="noopener">INSERT INTO LOGSTASH SELECT DATA FROM DATABASE</a></p>
<p>主要有下面几个技巧</p>
<h4 id="SQL剥离"><a href="#SQL剥离" class="headerlink" title="SQL剥离"></a>SQL剥离</h4><p>当然可以将SQL直接写入配置文件的<code>statement</code>配置项，但是会遇到与Elasticsearch-JDBC中同样遇到的特殊字符的问题和文本编码的问题。<br>更好的方式是将查询脚本存放在一个单独的SQL文件中，通过指定<code>statement_filepath</code>配置项来定位。</p>
<h4 id="时区指定"><a href="#时区指定" class="headerlink" title="时区指定"></a>时区指定</h4><p>如果不定义<code>jdbc_default_timezone</code>配置项，你的执行时间可能会受到系统环境的影响。这个配置项需要输入<code>UTC</code>中定义的时区，详见：<a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones" target="_blank" rel="noopener">wikipedia</a></p>
<h4 id="保存上一次执行的进度"><a href="#保存上一次执行的进度" class="headerlink" title="保存上一次执行的进度"></a>保存上一次执行的进度</h4><p>如果你的增量依赖于数据库的某个字段（比如自增的ID），可以配置：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">use_column_value</span> =&gt; <span class="literal">true</span></span><br><span class="line"><span class="attr">tracking_column</span> =&gt; id</span><br><span class="line"><span class="attr">last_run_metadata_path</span> =&gt; <span class="string">"'$DIR'/.logstash_jdbc_last_run"</span></span><br></pre></td></tr></table></figure></p>
<p>Lostash会将上一次导入数据的最大id存放在<code>.logstash_jdbc_last_run</code>文件中。<br>如果增量脚本是基于时间戳，则无需配置<code>use_column_value</code>。<br>使用的方式都是一样的，在SQL中使用<code>:sql_last_value</code>来引用先前的执行结果。</p>
<p>最终线上的增量同步脚本如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">indexname=<span class="variable">$1</span></span><br><span class="line">DIR=<span class="string">"<span class="variable">$( cd "$( dirname "$&#123;BASH_SOURCE[0]&#125;" )</span>"</span> &amp;&amp; <span class="built_in">pwd</span> )<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo '</span></span><br><span class="line"><span class="string">input &#123;</span></span><br><span class="line"><span class="string">    jdbc &#123;</span></span><br><span class="line"><span class="string">        jdbc_driver_library =&gt; "</span>/*/mysql-connector-java-5.1.40-bin.jar<span class="string">"</span></span><br><span class="line"><span class="string">        jdbc_driver_class =&gt; "</span>com.mysql.jdbc.Driver<span class="string">"</span></span><br><span class="line"><span class="string">        jdbc_connection_string =&gt; "</span>jdbc:mysql://www.maihaoche.comm/<span class="string">"</span></span><br><span class="line"><span class="string">        jdbc_user =&gt; "</span>mhc<span class="string">"</span></span><br><span class="line"><span class="string">        jdbc_password =&gt; "</span>mhc<span class="string">"</span></span><br><span class="line"><span class="string">        schedule =&gt; "</span>*/5 * * * * *<span class="string">"</span></span><br><span class="line"><span class="string">        statement_filepath =&gt; "</span><span class="string">'$DIR'</span>/confs/mhc.sql<span class="string">"</span></span><br><span class="line"><span class="string">        jdbc_default_timezone =&gt; "</span>Asia/Shanghai<span class="string">"</span></span><br><span class="line"><span class="string">        last_run_metadata_path =&gt; "</span><span class="string">'$DIR'</span>/.logstash_jdbc_last_run_car<span class="string">"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">output &#123;</span></span><br><span class="line"><span class="string">    elasticsearch &#123;</span></span><br><span class="line"><span class="string">        index =&gt; "</span>*<span class="string">"</span></span><br><span class="line"><span class="string">        document_type =&gt; "</span>*<span class="string">"</span></span><br><span class="line"><span class="string">        document_id =&gt; "</span>%&#123;id&#125;<span class="string">"</span></span><br><span class="line"><span class="string">        hosts =&gt; ["</span>*:9300<span class="string">"]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">' &gt; /*/<span class="variable">$indexname</span>.conf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/*/logstash/bin/logstash -f /*/logstash/bin/confs/<span class="variable">$indexname</span>.conf</span></span><br></pre></td></tr></table></figure></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>当然，从数据库同步到Elasticsearch还有很多更好的方式，比如</p>
<ul>
<li>解析数据库的binlog</li>
<li>直接通过hadoop构造lusence索引推送到Elasticsearch<br>等等，可以参见<a href="http://suclogger.me/Elasticsearch%E4%B8%AD%E6%96%87%E7%A4%BE%E5%8C%BA20160618%E6%9D%AD%E5%B7%9E%E7%BA%BF%E4%B8%8B%E8%81%9A%E4%BC%9A%E7%BA%AA%E8%A6%81/">Elasticsearch中文社区20160618杭州线下聚会纪要</a></li>
</ul>
<p>这些方式可以解决<strong>数据库物理删除同步到Elasticsearch</strong>的痛点。<br>但是更好的方式意味着更高的开发成本，希望日后可以有时间实现。</p>
<p>binlog这里不得不吐槽一下阿里云的RDS，如果自定开通binlog订阅则无法使用阿里云的DTS，如果要使用DTS必须使用阿里云提供的付费binlog订阅服务。<br>不得不感慨，<strong>这是一个最好的时代，也是一个最坏的时代</strong>。</p>

      
    </div>

    

    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/image/wechatpay.jpg" alt="Suclogger WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/image/alipay.png" alt="Suclogger Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/elasticsearch/" rel="tag"># elasticsearch</a>
          
            <a href="/tags/logstash/" rel="tag"># logstash</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/分布式系统设计迷思（二）/" rel="next" title="分布式系统设计迷思（二）">
                <i class="fa fa-chevron-left"></i> 分布式系统设计迷思（二）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/HTTPS之殇：绕过客户端的SSL证书绑定/" rel="prev" title="HTTPS之殇：绕过客户端的SSL证书绑定">
                HTTPS之殇：绕过客户端的SSL证书绑定 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Suclogger</p>
              <p class="site-description motion-element" itemprop="description">人生如逆旅，我亦是行人</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">51</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">31</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#洪荒时代"><span class="nav-number">1.</span> <span class="nav-text">洪荒时代</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-JDBC"><span class="nav-number">2.</span> <span class="nav-text">Elasticsearch-JDBC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#不支持多数据源"><span class="nav-number">2.1.</span> <span class="nav-text">不支持多数据源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL以json形式保存，因此不能带有特殊字符"><span class="nav-number">2.2.</span> <span class="nav-text">SQL以json形式保存，因此不能带有特殊字符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存泄露问题"><span class="nav-number">2.3.</span> <span class="nav-text">内存泄露问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据缺失问题"><span class="nav-number">2.4.</span> <span class="nav-text">数据缺失问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Logstash"><span class="nav-number">3.</span> <span class="nav-text">Logstash</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么不用Logstash？"><span class="nav-number">3.1.</span> <span class="nav-text">为什么不用Logstash？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么要用Logstash呢？"><span class="nav-number">3.2.</span> <span class="nav-text">为什么要用Logstash呢？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#支持Elasticsearch-5-0，-而且有官方支持"><span class="nav-number">3.2.1.</span> <span class="nav-text">支持Elasticsearch 5.0， 而且有官方支持</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#便于日后扩展输入和输出"><span class="nav-number">3.2.2.</span> <span class="nav-text">便于日后扩展输入和输出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Logstash-JDBC更快"><span class="nav-number">3.2.3.</span> <span class="nav-text">Logstash JDBC更快</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#占用系统资源更少"><span class="nav-number">3.2.4.</span> <span class="nav-text">占用系统资源更少</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#迁移到Logstash"><span class="nav-number">3.3.</span> <span class="nav-text">迁移到Logstash</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SQL剥离"><span class="nav-number">3.3.1.</span> <span class="nav-text">SQL剥离</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#时区指定"><span class="nav-number">3.3.2.</span> <span class="nav-text">时区指定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#保存上一次执行的进度"><span class="nav-number">3.3.3.</span> <span class="nav-text">保存上一次执行的进度</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他"><span class="nav-number">4.</span> <span class="nav-text">其他</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Suclogger</span>

  

  
</div>


  



  <div class="powered-by">Powered by <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" rel="external nofollow" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.2.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.2.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  

  
    <script id="dsq-count-scr" src="https://suclogger.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'https://suclogger.me/MySQL到Elasticsearch的同步之路/';
        this.page.identifier = 'MySQL到Elasticsearch的同步之路/';
        this.page.title = 'MySQL到Elasticsearch的同步之路';
      };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://suclogger.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        $(function () {
          var offsetTop = $('#comments').offset().top - $(window).height();
          if (offsetTop <= 0) {
            // load directly when there's no a scrollbar
            loadComments();
          } else {
            $(window).on('scroll.disqus_scroll', function () {
              var scrollTop = document.documentElement.scrollTop;
              if (scrollTop >= offsetTop) {
                $(window).off('.disqus_scroll');
                loadComments();
              }
            });
          }
        });
      
    </script>
  





	





  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

  

</body>
</html>
