<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/image/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/image/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/image/favicon.png">
  <link rel="mask-icon" href="/image/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://suclogger.me').hostname,
    root: '/',
    scheme: 'Muse',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="人生如逆旅，我亦是行人">
<meta property="og:type" content="website">
<meta property="og:title" content="Suclogger">
<meta property="og:url" content="https://suclogger.me/page/19/index.html">
<meta property="og:site_name" content="Suclogger">
<meta property="og:description" content="人生如逆旅，我亦是行人">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Suclogger">
<meta name="twitter:description" content="人生如逆旅，我亦是行人">

<link rel="canonical" href="https://suclogger.me/page/19/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Suclogger</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Suclogger</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">莆放</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>Sitemap</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://suclogger.me/记一个线上bug的解决/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/image/avatar.png">
      <meta itemprop="name" content="Suclogger">
      <meta itemprop="description" content="人生如逆旅，我亦是行人">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Suclogger">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/记一个线上bug的解决/" class="post-title-link" itemprop="url">记一个线上bug的解决</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-05-27 22:56:03" itemprop="dateCreated datePublished" datetime="2016-05-27T22:56:03+08:00">2016-05-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2016-05-30 14:49:39" itemprop="dateModified" datetime="2016-05-30T14:49:39+08:00">2016-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/记一个线上bug的解决/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="记一个线上bug的解决/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- abstract -->
<!-- 开始正文 -->
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>我司的爬虫现在运行在一个通过ADSL拨号联网的VPS上，通过重新拨号切换IP来应对目标网站的防爬措施。</p>
<h2 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h2><p>应用通过<a href="https://github.com/alibaba/druid" target="_blank" rel="noopener">druid</a>数据源连接到mysql保存数据，每次切换IP后，会通过下面这条简单sql尝试获取数据源连接：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT &apos;1&apos; FROM DUAL;</span><br></pre></td></tr></table></figure></p>
<p>但是通过查看日志这条sql每次都要等待长达17分钟才能执行完成：<br><img src="/image/3c91ebb0cbc84db0befa2f276df8fa19.jpg?r=59" alt></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>数据库的连接是长连接，IP切换之后原先的TCP长连接也都被断开，需要重新获取数据库连接，但是VPS到数据的连接延时稳定在20ms以内，ADSL拨号重建连接的耗时也在2s以内，重建TCP链路不应该耗时17分钟之久：<br>    <img src="/image/2016-05-27 23-28-05.jpg" alt></p>
<h3 id="bleedfly猜测mysql服务器可能受到DNS污染。"><a href="#bleedfly猜测mysql服务器可能受到DNS污染。" class="headerlink" title="@bleedfly猜测mysql服务器可能受到DNS污染。"></a><a href="https://twitter.com/bleedfly" target="_blank" rel="noopener">@bleedfly</a>猜测mysql服务器可能受到DNS污染。</h3><p>手动重新拨号之后ping接mysql域名，发现解析正确。<br>通过<code>yum install mysql</code>命令在VPS（CentOS）主机上安装mysql客户端后也可以在拨号之后迅速正常连接到mysql，遂排除这一可能。</p>
<h3 id="尝试根据内存dump文件发现问题"><a href="#尝试根据内存dump文件发现问题" class="headerlink" title="尝试根据内存dump文件发现问题"></a>尝试根据内存dump文件发现问题</h3><p>通过以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo jmap -dump:live,format=b,file=/root/log.bin `pgrep java`</span><br></pre></td></tr></table></figure></p>
<p>获取内存dump文件，放入<a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener">MAT</a>中分析：</p>
<p><img src="/image/2016-05-28 00-00-55.jpg" alt></p>
<p>可以看到停顿时内存的使用量很小，不存在内存泄露的可能。<br>列出的<code>suspect problem</code>中也看只反映了当时内存中主要存活的对象是<code>org.apache.ibatis.session.Configuration</code>。</p>
<h3 id="分析堆栈日志"><a href="#分析堆栈日志" class="headerlink" title="分析堆栈日志"></a>分析堆栈日志</h3><p>通过以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack `pgrep java` &gt; jstack.log</span><br></pre></td></tr></table></figure></p>
<p>获取方法调用堆栈进行分析。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">2016-05-27 20:14:56</span><br><span class="line">Full thread dump OpenJDK 64-Bit Server VM (24.95-b01 mixed mode):</span><br><span class="line"></span><br><span class="line">&quot;Attach Listener&quot; daemon prio=10 tid=0x00007f1b14001000 nid=0x28a2 waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;pool-3-thread-1&quot; prio=10 tid=0x00007f1af80c0800 nid=0x274b runnable [0x00007f1b02286000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">	at java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class="line">	at java.net.SocketInputStream.read(SocketInputStream.java:152)</span><br><span class="line">	at java.net.SocketInputStream.read(SocketInputStream.java:122)</span><br><span class="line">	at com.mysql.jdbc.util.ReadAheadInputStream.fill(ReadAheadInputStream.java:114)</span><br><span class="line">	at com.mysql.jdbc.util.ReadAheadInputStream.readFromUnderlyingStreamIfNecessary(ReadAheadInputStream.java:161)</span><br><span class="line">	at com.mysql.jdbc.util.ReadAheadInputStream.read(ReadAheadInputStream.java:189)</span><br><span class="line">	- locked &lt;0x0000000785ce9b80&gt; (a com.mysql.jdbc.util.ReadAheadInputStream)</span><br><span class="line">	at com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2536)</span><br><span class="line">	at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:2989)</span><br><span class="line">	at com.mysql.jdbc.MysqlIO.reuseAndReadPacket(MysqlIO.java:2978)</span><br><span class="line">	at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3526)</span><br><span class="line">	at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:1989)</span><br><span class="line">	at com.mysql.jdbc.ConnectionImpl.pingInternal(ConnectionImpl.java:4051)</span><br><span class="line">	at com.mysql.jdbc.ConnectionImpl.ping(ConnectionImpl.java:4028)</span><br><span class="line">	at sun.reflect.GeneratedMethodAccessor14.invoke(Unknown Source)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:606)</span><br><span class="line">	at com.alibaba.druid.pool.vendor.MySqlValidConnectionChecker.isValidConnection(MySqlValidConnectionChecker.java:79)</span><br><span class="line">	at com.alibaba.druid.pool.DruidAbstractDataSource.testConnectionInternal(DruidAbstractDataSource.java:1166)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource.getConnectionDirect(DruidDataSource.java:668)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:628)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:618)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:79)</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.doGetConnection(DataSourceUtils.java:111)</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.getConnection(DataSourceUtils.java:77)</span><br><span class="line">	at org.mybatis.spring.transaction.SpringManagedTransaction.openConnection(SpringManagedTransaction.java:83)</span><br><span class="line">	at org.mybatis.spring.transaction.SpringManagedTransaction.getConnection(SpringManagedTransaction.java:69)</span><br><span class="line">	at org.apache.ibatis.executor.BaseExecutor.getConnection(BaseExecutor.java:271)</span><br><span class="line">	at org.apache.ibatis.executor.SimpleExecutor.prepareStatement(SimpleExecutor.java:69)</span><br><span class="line">	at org.apache.ibatis.executor.SimpleExecutor.doQuery(SimpleExecutor.java:56)</span><br><span class="line">	at org.apache.ibatis.executor.BaseExecutor.queryFromDatabase(BaseExecutor.java:259)</span><br><span class="line">	at org.apache.ibatis.executor.BaseExecutor.query(BaseExecutor.java:132)</span><br><span class="line">	at org.apache.ibatis.executor.CachingExecutor.query(CachingExecutor.java:105)</span><br><span class="line">	at org.apache.ibatis.executor.CachingExecutor.query(CachingExecutor.java:81)</span><br><span class="line">	at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:104)</span><br><span class="line">	at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:98)</span><br><span class="line">	at org.apache.ibatis.session.defaults.DefaultSqlSession.selectOne(DefaultSqlSession.java:62)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:606)</span><br><span class="line">	at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:358)</span><br><span class="line">	at com.sun.proxy.$Proxy13.selectOne(Unknown Source)</span><br><span class="line">	at org.mybatis.spring.SqlSessionTemplate.selectOne(SqlSessionTemplate.java:163)</span><br><span class="line">	at org.apache.ibatis.binding.MapperMethod.execute(MapperMethod.java:63)</span><br><span class="line">	at org.apache.ibatis.binding.MapperProxy.invoke(MapperProxy.java:43)</span><br><span class="line">	at com.sun.proxy.$Proxy27.initCookie(Unknown Source)</span><br><span class="line">	at com.renault.cookie.manager.impl.CookieManagerImpl.getCookie(CookieManagerImpl.java:127)</span><br><span class="line">	at com.renault.core.webmagic.cookie.WcXcCookieProvider.getCookie(WcXcCookieProvider.java:40)</span><br><span class="line">	at us.codecraft.webmagic.downloader.HttpClientGenerator.generateCookie(HttpClientGenerator.java:92)</span><br><span class="line">	at us.codecraft.webmagic.downloader.HttpClientGenerator.generateClient(HttpClientGenerator.java:73)</span><br><span class="line">	at us.codecraft.webmagic.downloader.HttpClientGenerator.getClient(HttpClientGenerator.java:45)</span><br><span class="line">	at us.codecraft.webmagic.downloader.HttpClientDownloader.getHttpClient(HttpClientDownloader.java:69)</span><br><span class="line">	at us.codecraft.webmagic.downloader.HttpClientDownloader.download(HttpClientDownloader.java:97)</span><br><span class="line">	at us.codecraft.webmagic.Spider.processRequest(Spider.java:409)</span><br><span class="line">	at us.codecraft.webmagic.Spider$1.run(Spider.java:322)</span><br><span class="line">	at us.codecraft.webmagic.thread.CountableThreadPool$1.run(CountableThreadPool.java:74)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"></span><br><span class="line">&quot;DestroyJavaVM&quot; prio=10 tid=0x00007f1b4c00c000 nid=0x2723 waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;pool-2-thread-1&quot; prio=10 tid=0x00007f1b4c1d2800 nid=0x2743 waiting on condition [0x00007f1b03518000]</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">	at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">	- parking to wait for  &lt;0x00000007831c9fd8&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)</span><br><span class="line">	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043)</span><br><span class="line">	at us.codecraft.webmagic.thread.CountableThreadPool.execute(CountableThreadPool.java:61)</span><br><span class="line">	at us.codecraft.webmagic.Spider.run(Spider.java:318)</span><br><span class="line">	at com.renault.core.webmagic.craw.WcXcCrawler.crawl(WcXcCrawler.java:66)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:606)</span><br><span class="line">	at org.springframework.scheduling.support.ScheduledMethodRunnable.run(ScheduledMethodRunnable.java:65)</span><br><span class="line">	at org.springframework.scheduling.support.DelegatingErrorHandlingRunnable.run(DelegatingErrorHandlingRunnable.java:54)</span><br><span class="line">	at org.springframework.scheduling.concurrent.ReschedulingRunnable.run(ReschedulingRunnable.java:81)</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:262)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:178)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:292)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"></span><br><span class="line">&quot;commons-pool-EvictionTimer&quot; daemon prio=10 tid=0x00007f1b4cb7d000 nid=0x2742 in Object.wait() [0x00007f1b034d8000]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (on object monitor)</span><br><span class="line">	at java.lang.Object.wait(Native Method)</span><br><span class="line">	- waiting on &lt;0x0000000782824838&gt; (a java.util.TaskQueue)</span><br><span class="line">	at java.util.TimerThread.mainLoop(Timer.java:552)</span><br><span class="line">	- locked &lt;0x0000000782824838&gt; (a java.util.TaskQueue)</span><br><span class="line">	at java.util.TimerThread.run(Timer.java:505)</span><br><span class="line"></span><br><span class="line">&quot;Druid-ConnectionPool-Destory&quot; daemon prio=10 tid=0x00007f1b4ca8f000 nid=0x273f waiting on condition [0x00007f1b1804e000]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (sleeping)</span><br><span class="line">	at java.lang.Thread.sleep(Native Method)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource$DestroyConnectionThread.run(DruidDataSource.java:1292)</span><br><span class="line"></span><br><span class="line">&quot;Druid-ConnectionPool-Create&quot; daemon prio=10 tid=0x00007f1b4ca88800 nid=0x273e waiting on condition [0x00007f1b1808f000]</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">	at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">	- parking to wait for  &lt;0x0000000785a217a8&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)</span><br><span class="line">	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource$CreateConnectionThread.run(DruidDataSource.java:1195)</span><br><span class="line"></span><br><span class="line">&quot;Service Thread&quot; daemon prio=10 tid=0x00007f1b4c1b1800 nid=0x2730 runnable [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;C2 CompilerThread1&quot; daemon prio=10 tid=0x00007f1b4c1ae800 nid=0x272f waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;C2 CompilerThread0&quot; daemon prio=10 tid=0x00007f1b4c1ac800 nid=0x272e waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;Signal Dispatcher&quot; daemon prio=10 tid=0x00007f1b4c1aa000 nid=0x272d runnable [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;Surrogate Locker Thread (Concurrent GC)&quot; daemon prio=10 tid=0x00007f1b4c1a8000 nid=0x272c waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;Finalizer&quot; daemon prio=10 tid=0x00007f1b4c17b800 nid=0x272b in Object.wait() [0x00007f1b4854b000]</span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">	at java.lang.Object.wait(Native Method)</span><br><span class="line">	- waiting on &lt;0x0000000785a217c0&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:135)</span><br><span class="line">	- locked &lt;0x0000000785a217c0&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:151)</span><br><span class="line">	at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:209)</span><br><span class="line"></span><br><span class="line">&quot;Reference Handler&quot; daemon prio=10 tid=0x00007f1b4c179800 nid=0x272a in Object.wait() [0x00007f1b50078000]</span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">	at java.lang.Object.wait(Native Method)</span><br><span class="line">	- waiting on &lt;0x0000000785a217f0&gt; (a java.lang.ref.Reference$Lock)</span><br><span class="line">	at java.lang.Object.wait(Object.java:503)</span><br><span class="line">	at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:133)</span><br><span class="line">	- locked &lt;0x0000000785a217f0&gt; (a java.lang.ref.Reference$Lock)</span><br><span class="line"></span><br><span class="line">&quot;VM Thread&quot; prio=10 tid=0x00007f1b4c175000 nid=0x2729 runnable </span><br><span class="line"></span><br><span class="line">&quot;Gang worker#0 (Parallel GC Threads)&quot; prio=10 tid=0x00007f1b4c01d800 nid=0x2724 runnable </span><br><span class="line"></span><br><span class="line">&quot;Gang worker#1 (Parallel GC Threads)&quot; prio=10 tid=0x00007f1b4c01f800 nid=0x2725 runnable </span><br><span class="line"></span><br><span class="line">&quot;Gang worker#2 (Parallel GC Threads)&quot; prio=10 tid=0x00007f1b4c021000 nid=0x2726 runnable </span><br><span class="line"></span><br><span class="line">&quot;Gang worker#3 (Parallel GC Threads)&quot; prio=10 tid=0x00007f1b4c023000 nid=0x2727 runnable </span><br><span class="line"></span><br><span class="line">&quot;Concurrent Mark-Sweep GC Thread&quot; prio=10 tid=0x00007f1b4c0a3800 nid=0x2728 runnable </span><br><span class="line">&quot;VM Periodic Task Thread&quot; prio=10 tid=0x00007f1b4c1bc800 nid=0x2731 waiting on condition </span><br><span class="line"></span><br><span class="line">JNI global references: 150</span><br></pre></td></tr></table></figure></p>
<p>排除了标明为<code>RUNNABLE</code>的线程之后，首先寻找是否有处于<code>Deadlock</code>状态的线程。<br>没有发现Deadlock，如果有可能等待时间就不止17分钟了。</p>
<p>接下来罗列处于<code>WAITING</code>状态的线程：</p>
<ol>
<li>“pool-2-thread-1” prio=10 tid=0x00007f1b4c1d2800 nid=0x2743 waiting on condition [0x00007f1b03518000] java.lang.Thread.State: WAITING (parking)</li>
<li>“commons-pool-EvictionTimer” daemon prio=10 tid=0x00007f1b4cb7d000 nid=0x2742 in Object.wait() [0x00007f1b034d8000] java.lang.Thread.State: TIMED_WAITING (on object monitor)</li>
<li>“Druid-ConnectionPool-Destory” daemon prio=10 tid=0x00007f1b4ca8f000 nid=0x273f waiting on condition [0x00007f1b1804e000] java.lang.Thread.State: TIMED_WAITING (sleeping)</li>
<li>“Druid-ConnectionPool-Create” daemon prio=10 tid=0x00007f1b4ca88800 nid=0x273e waiting on condition [0x00007f1b1808f000] java.lang.Thread.State: WAITING (parking)</li>
<li>“Finalizer” daemon prio=10 tid=0x00007f1b4c17b800 nid=0x272b in Object.wait() [0x00007f1b4854b000]  java.lang.Thread.State: WAITING (on object monitor)</li>
<li>“Reference Handler” daemon prio=10 tid=0x00007f1b4c179800 nid=0x272a in Object.wait() [0x00007f1b50078000]  java.lang.Thread.State: WAITING (on object monitor)</li>
</ol>
<p>其中，第2个：”commons-pool-EvictionTimer” 用于空闲对象的驱逐，第5个：”Finalizer”线程用于在垃圾收集前，调用对象的finalize()方法，第6个：”Reference Handler”用于处理引用对象本身（软引用、弱引用、虚引用）的垃圾回收问题 ，这3个线程都从属于JVM，暂时忽略。</p>
<p>粗略看来剩下的3个线程中，第1个和第4个都处于<code>WAITING (parking)</code>的状态，即依赖于<code>特定condition</code>的发生，而第3个处于<code>TIMED_WAITING (sleeping)</code>，很可能是方法调用了Thread.wait()或者Thread.sleep()。</p>
<p>查看pom文件，找到版本号<code>0.2.9</code>，在druid目录通过check out到对应版本号的tag定位源代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public class DestroyConnectionThread extends Thread &#123;</span><br><span class="line"></span><br><span class="line">    public DestroyConnectionThread(String name)&#123;</span><br><span class="line">        super(name);</span><br><span class="line">        this.setDaemon(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void run() &#123;</span><br><span class="line">        initedLatch.countDown();</span><br><span class="line"></span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            // 从前面开始删除</span><br><span class="line">            try &#123;</span><br><span class="line">                if (closed) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (timeBetweenEvictionRunsMillis &gt; 0) &#123;</span><br><span class="line">                    Thread.sleep(timeBetweenEvictionRunsMillis);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    Thread.sleep(1000); // 这里是1292行</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (Thread.interrupted()) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                shrink(true);</span><br><span class="line"></span><br><span class="line">                if (isRemoveAbandoned()) &#123;</span><br><span class="line">                    removeAbandoned();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的代码逻辑是这个独立的线程是用于回收关闭的链接，由于run方法一开始已经调用了<code>initedLatch.countDown();</code>，应该不会影响主线程，所以第3个线程也不是罪魁祸首。</p>
<p>找来找去，怀疑的目光又落在了<code>pool-3-thread-1</code>这个最早看来人畜无害的<code>Runable</code>线程。<br>猛烈google之后，发现了相关的讨论：<a href="https://bugs.mysql.com/bug.php?id=9515" target="_blank" rel="noopener">Long response waiting using Connector</a></p>
<blockquote>
<p>always close the connection and use Socket.setSoTimeout(int) on every connection, I solve my problem. the hanging does never appear again.</p>
</blockquote>
<p>又返回去看druid的源码，发现方法调用堆栈中<code>isValidConnection</code>是支持设置超时时间的，需要在<code>DruidDataSource</code>实例化时作为参数传入。</p>
<h2 id="尝试"><a href="#尝试" class="headerlink" title="尝试"></a>尝试</h2><p>修改xml配置，给<code>datasource</code>的bean中加上下列配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=&quot;validationQueryTimeout&quot; value=&quot;1000&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>但是实际发现没有起作用，底层的socket连接依然在等待。又发现druid最新版本（1.0.20）中已经给<code>validationQueryTimeout</code>设置了默认值<code>1000ms</code>，尝试更新druid，最新版依然存在问题。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>又认真想了一遍。<br>druid通过<code>MySqlValidConnectionChecker</code>调用<code>com.mysql.jdbc.ConnectionImpl.pingInternal(boolean checkForClosedConnection, int timeoutMillis)</code>方法，并将validationQueryTimeout作为它的超时值。</p>
<p>druid作为一个datasource pool，不管是选择在收回connection到pool的时候检验connection，还是从poll拿connection的时候检验connection，选择信任<code>pingInternal()</code>方法是无可厚非的。</p>
<p>那锅是要由JDBC的驱动里面的<code>pingInternal()</code>方法来背吗？也不尽然：<a href="https://bugs.mysql.com/bug.php?id=31353" target="_blank" rel="noopener">mysq上的讨论</a></p>
<blockquote>
<p><em>Socket timeouts</em>:<br>UNCLOSED socket connection; JVM specs tell us GC does NOT release these resources thus they exhaust JVM resources related to socket operation, leading to SocketInputStream hanging your program. Always close the connection and use Socket.setSoTimeout(int) on every connection.</p>
</blockquote>
<blockquote>
<p>Now this is in relation with <em>pooled connections</em> and DBCP (or “why does 1.2.1 work”, from Bug#30990):<br>If you’re using a connection pool that <em>doesn’t</em> use the ConnectionPoolDataSource API to create connections that have lifecycle callbacks, then it is the <em>pool’s</em> responsibility to cleanup “logical” pooled connections when they’re returned to the pool. Otherwise there is no way for a JDBC driver to tell that a connection is being pooled “above” it, and thus no event/method call where one can hook in to determine that you’ve been “logically” closed and returned to the pool.<br>More recent version of DBCP automatically call rollback() on connections that are returned to the pool.</p>
</blockquote>
<p>所以，如果我们还想继续使用druid，还是老老实实在重新切换IP断网之前，调用一下<code>DruidDataDource.close()</code>方法显式地关闭connection好了。</p>
<p>其实刚开始我们就通过将数据源切换到<code>DriverManagerDataSource</code>已经歪打正着解决了问题，但是<code>DriverManagerDataSource</code>不是一个连接池，每次都要重新创建connection，所以既然定位了问题，还是用druid更为优雅一些。</p>
<p>解决后可以实现切换动作在1s内完成。<br><img src="/image/2016-05-30 14-17-50.jpg" alt></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://suclogger.me/到底需不需要Manager层？/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/image/avatar.png">
      <meta itemprop="name" content="Suclogger">
      <meta itemprop="description" content="人生如逆旅，我亦是行人">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Suclogger">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/到底需不需要Manager层？/" class="post-title-link" itemprop="url">到底需不需要Manager层？</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2016-05-18 00:09:55 / Modified: 00:48:33" itemprop="dateCreated datePublished" datetime="2016-05-18T00:09:55+08:00">2016-05-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/到底需不需要Manager层？/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="到底需不需要Manager层？/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- abstract -->
<p>今天跟同事们一起主要就是否需要按照严格的分层架构来规范当前代码讨论了应用的几个架构问题。<br><!-- 开始正文 --><br>之前第一家公司采用的是经典的SpringMVC架构，主要划分为Controller，Service，DAO三层。Controller层控制页面逻辑，数据库操作通过自己编写hql在DAO层实现，事务控制在Service层。这样的架构容易理解和上手，但是无法对DAO层的代码逻辑进行控制，很容易出现以下问题：</p>
<ol>
<li>自定义的hql逻辑比较随意，容易出现多表关联查询导致数据库的执行效率很低。</li>
<li>容易出现Service层方法的相互调用导致事务嵌套，容易出现很多比较难以排查的bug。</li>
<li>Service层和DAO层的代码都很容易变动，导致编写单元测试的成本比较高，而且DAO层一旦出现bug对应用整体的影响很大，曾经有一次线上应用一直崩溃，查找了2天才发现是因为调用了一个很古老的有问题的DAO层方法。</li>
</ol>
<p>现在我司采用的架构沿袭自阿里，主要分为Controller，AO（Service），Manager，Mapper（DAO）四层，与经典的MVC3层架构相比多了一层Manager层。今天主要讨论了这一层的存在是否有必要。</p>
<p><a href="https://twitter.com/bleedfly" target="_blank" rel="noopener">@bleedfly</a>的观点是，DAO层只负责CRUD的逻辑，Manager层用于处理多表关联，所有业务逻辑止步AO层。</p>
<p>理论听起来是很有道理，但是如果没有严格的规范控制，就很难确保严格执行。<br>很常见的一种情况是，如果整个Service层只需要一个方法，该方法的逻辑只是从根据一个主键值从一张表中取一条记录，如果严格按照规范，就需要写一个Manager层方法和一个Mapper（DAO）层方法，而且这两层的方法逻辑是一样的，直接将Mapper注入Service可以达到同样的效果。如果不假思索的话，很容易打破上述代码规范。</p>
<p>严格满足规范有什么好处呢？</p>
<ol>
<li>Mapper（DAO）层代码很固定，不容易出现文章开头出现的DAO层的严重事故。</li>
<li>事务控制在Manager层，Manager层方法不允许相互调用，不会出现事务嵌套的问题。</li>
<li>为了避免在数据库执行join操作，Manager层负责采用循环控制分别查询，可以有效缓解数据库压力。（PS.当前线上业务挂掉，最先挂的肯定都是数据库，尽管通过读写方式的形式简单隔离了一下数据库，但是数据库的瓶颈在代码依然中是着重考虑的方面）</li>
</ol>
<p>实际工作中经常出现效率和规范冲突的情况，但是满足规范才是保证代码质量和规避风险的最佳实践。所以下班之前把今天有争议的代码都重构了，感觉神清气爽。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://suclogger.me/从webmagic着手浅析JAVA爬虫/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/image/avatar.png">
      <meta itemprop="name" content="Suclogger">
      <meta itemprop="description" content="人生如逆旅，我亦是行人">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Suclogger">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/从webmagic着手浅析JAVA爬虫/" class="post-title-link" itemprop="url">从webmagic着手浅析JAVA爬虫</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-05-17 11:41:07" itemprop="dateCreated datePublished" datetime="2016-05-17T11:41:07+08:00">2016-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-04-23 22:07:35" itemprop="dateModified" datetime="2018-04-23T22:07:35+08:00">2018-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/爬虫/" itemprop="url" rel="index">
                    <span itemprop="name">爬虫</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/从webmagic着手浅析JAVA爬虫/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="从webmagic着手浅析JAVA爬虫/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- abstract -->
<p>用于我司内部分享会，主要结合做过的项目简单介绍一下常用的爬虫模式。<br><!-- 开始正文 --></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>什么是爬虫？</p>
<blockquote>
<p><a href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF%E8%9C%98%E8%9B%9B" target="_blank" rel="noopener">网络蜘蛛</a></p>
</blockquote>
<p>关于爬虫是否合法的讨论？</p>
<blockquote>
<p><a href="https://www.v2ex.com/t/268607" target="_blank" rel="noopener">用爬虫抓取数据，这样的行为是否合法</a></p>
</blockquote>
<p>比较知名的开源的爬虫主要包括：<br>JAVA : <a href="https://github.com/code4craft/webmagic" title="Webmagic" target="_blank" rel="noopener">Webmagic</a>，<a href="https://github.com/CrawlScript/WebCollector" title="WebCollector" target="_blank" rel="noopener">WebCollector</a>，<a href="https://github.com/yasserg/crawler4j" title="Crawler4j" target="_blank" rel="noopener">Crawler4j</a><br>PYTHON :  <a href="https://github.com/scrapy/scrapy" title="Scrapy" target="_blank" rel="noopener"> Scrapy</a></p>
<h2 id="简单的爬虫"><a href="#简单的爬虫" class="headerlink" title="简单的爬虫"></a>简单的爬虫</h2><p><code>简单的网络爬虫</code>可以只是遍历一个存放URL的集合并通过<code>HttpClient</code>发送网络请求：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">CloseableHttpClient httpclient = HttpClients.createDefault();</span><br><span class="line">try &#123;</span><br><span class="line">    HttpGet httpget = new HttpGet(&quot;http://httpbin.org/&quot;);</span><br><span class="line">    ResponseHandler&lt;String&gt; responseHandler = new ResponseHandler&lt;String&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public String handleResponse( HttpResponse response) throws IOException &#123;</span><br><span class="line">            int status = response.getStatusLine().getStatusCode();</span><br><span class="line">            if (status &gt;= 200 &amp;&amp; status &lt; 300) &#123;</span><br><span class="line">                HttpEntity entity = response.getEntity();</span><br><span class="line">                return entity != null ? EntityUtils.toString(entity) : null;</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    String responseBody = httpclient.execute(httpget, responseHandler);</span><br><span class="line">&#125; catch (IOException e)&#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; finally &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        httpclient.close();</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="好的爬虫"><a href="#好的爬虫" class="headerlink" title="好的爬虫"></a>好的爬虫</h2><p>一个<code>好的爬虫框架</code>相比简单的爬虫，应该包含了以下特性：</p>
<ol>
<li>支持多线程</li>
<li>支持代理</li>
<li>支持过滤重复URL</li>
<li>支持爬取ajax返回信息</li>
<li>支持爬取需要登录验证的网页信息（Cookie管理）</li>
<li>支持持久化保存爬取到的信息</li>
<li>支持错误处理（IP被封禁或者登录信息失效后的处理）</li>
<li>支持停止后从断点继续</li>
<li>准确，快速地抓取所需信息<br>为了给一个简单的爬虫整合这些特性，需要做一个简单的框架设计。</li>
</ol>
<h2 id="优雅的框架设计"><a href="#优雅的框架设计" class="headerlink" title="优雅的框架设计"></a>优雅的框架设计</h2><p><code>Scrapy</code>的框架：</p>
<p><img src="/image/2016-05-18 at 上午9.33.jpeg" alt="Scrapy Structure"></p>
<ul>
<li><code>Spider</code>创建<code>Request</code>，处理<code>Response</code>,生成<code>Items</code>和后续<code>Request</code>。</li>
<li><code>Items</code>是从Response中由抽取出的所需信息组合而成的一个个POJO。</li>
<li>Spider生成的<code>Items</code>经<code>process_item()</code>方法交由一系列的<code>Item Pipelines</code>进行处理。</li>
<li><code>Pipeline</code>处理<code>Items</code>，可以是保存到数据库，打印到控制台，提交给Elasticsearch等等。</li>
<li><code>Downloader</code>负责实际的下载行为，接收传入的Request请求，输出Response。</li>
</ul>
<p><code>Webmagic</code>的框架：<br><img src="/image/2016-05-18 at 上午11.16.jpeg" alt="webmagic structure"></p>
<p>Webmagic的框架设计大部分沿袭了Scrapy：</p>
<ul>
<li><code>Downloader</code>负责从互联网上下载页面，以便后续处理。WebMagic默认使用了Apache HttpClient作为下载工具。</li>
<li><code>PageProcessor</code> 负责解析页面，抽取有用信息，以及发现新的链接。</li>
<li><code>Scheduler</code>负责管理待抓取的URL，以及一些去重的工作。</li>
<li><code>Pipeline</code>负责抽取结果的处理，包括计算、持久化到文件、数据库等。<br><strong><code>Webmagic</code>很好的贯彻了<code>面向接口</code>的设计思想，我们可以很容易地对上述的组件进行自定义和扩展。</strong><br>更进一步，可以通过修改webmgic的源代码来满足我们的定制化需求。</li>
</ul>
<h2 id="储备知识"><a href="#储备知识" class="headerlink" title="储备知识"></a>储备知识</h2><h3 id="通过XPath获取页面元素"><a href="#通过XPath获取页面元素" class="headerlink" title="通过XPath获取页面元素"></a>通过XPath获取页面元素</h3><p>常见的从html页面获取元素的方式是通过<code>Jsoup</code>，它支持用<code>CSS Selector</code>方式选择DOM元素，也可过滤HTML文本。</p>
<blockquote>
<p>参见<code>renault</code>中Craw168.java的实现</p>
</blockquote>
<p>这里主要介绍通过Xpath语法获取页面元素。Xpath语法介绍请见：<a href="http://www.w3school.com.cn/xpath/" target="_blank" rel="noopener">Xpath语法</a><br>由于Jsoup暂不支持Xpath语法，webmagic中集成了<a href="https://github.com/code4craft/xsoup" target="_blank" rel="noopener">Xsoup</a>来实现对Xpath语法的支持。但是由于Xsoup项目疏于维护，对Xpath的语法支持不全，我个人给webmgic添加了<code>JsoupXpath</code>来支持<code>Xpath</code>语法。JsoupXpath项目地址：<a href="https://github.com/zhegexiaohuozi/JsoupXpath" target="_blank" rel="noopener">JsoupXpath</a></p>
<h4 id="在chrome中调试xpath"><a href="#在chrome中调试xpath" class="headerlink" title="在chrome中调试xpath"></a>在chrome中调试xpath</h4><p>通过 开发者工具-元素选择栏 可以快速获取所需元素的xpath路径：<br><img src="/image/2016-05-18 at 下午5.00.jpeg" alt="chrome xpath chose"></p>
<p>在console中可以使用<code>$x(&quot;XPath路径&quot;)</code>来定位xpath对应的元素：<br><img src="/image/2016-05-18 at 下午5.04.jpeg" alt="get element by xpath in chrome"></p>
<h4 id="在firefox中调试xpath"><a href="#在firefox中调试xpath" class="headerlink" title="在firefox中调试xpath"></a>在firefox中调试xpath</h4><p>通过安装插件<code>XPath Checker</code>来调试xpath：<br>查看：<br><img src="/image/2016-05-18 at 下午5.06.jpeg?r=42" alt="firefox xpath chose"><br>获取元素：<br><img src="/image/2016-05-18 at 下午5.07.jpeg?r=56" alt="get element by xpath in firefox"></p>
<h4 id="使用xpath需要遵循的几个原则"><a href="#使用xpath需要遵循的几个原则" class="headerlink" title="使用xpath需要遵循的几个原则"></a>使用xpath需要遵循的几个原则</h4><ol>
<li>避免使用数组的形式获取元素，如<code>//*[@id=&quot;myid&quot;]/div/div/div[1]/div[2]/div/div[1]/div[1]/a/img</code>。这种形式的xpath表达式是很脆弱的，因为页面的元素的排列很可能受到广告的插入，其他信息的存在与否而导致数组依赖的div的显示与否 等等因素的影响。通过chrome或者firefox自动获取的xpath通常是这种形式，要记得对得到的结果进行一定处理。<br>举个例子：<br>第一个页面上使用<code>li[9]</code>路径来获取页面上的<code>QQ</code>元素，但是第二页面中由于没有对应的元素，导致后面的元素使用了<code>li[9]</code>路径，这时候如果还用<code>li[9]</code>路径来获取页面上的<code>QQ</code>元素，就会得到错误的元素：<br><img src="/image/2016-05-20 16-26-24.jpg?f=1" alt>  <img src="/image/2016-05-20 16-27-15.jpg?f=2" alt></li>
<li>避免采用元素的<code>class</code>属性来获取元素，如<code>//div[@class=&quot;red&quot;]/a/img</code>。因为class通常用于控制页面元素的样式，一旦页面的样式风格发生变化，对应元素的class也极有可能发生变化。</li>
<li>元素的<code>id</code>属性通常是最为可靠的，如<code>//*[@id=&quot;more_info&quot;]//text()</code>。</li>
</ol>
<p>接下来就用一个简单的实例进入实战：</p>
<h2 id="一个简单的webmgic的例子"><a href="#一个简单的webmgic的例子" class="headerlink" title="一个简单的webmgic的例子"></a>一个简单的webmgic的例子</h2><h3 id="CaoLiuCraw"><a href="#CaoLiuCraw" class="headerlink" title="CaoLiuCraw"></a>CaoLiuCraw</h3><p>CaoLiuProcessor.java:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public class CaoLiuProcessor implements PageProcessor &#123;</span><br><span class="line">    private Site site = Site.me()</span><br><span class="line">            .setUserAgent(&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36&quot;)</span><br><span class="line">            .setCharset(&quot;GBK&quot;).setDomain(&quot;cl.pclmm.org&quot;).setSleepTime(5000)</span><br><span class="line">            .setHttpProxy(new HttpHost(&quot;localhost&quot;,6152));</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void process(Page page) &#123;</span><br><span class="line">        String title = page.getHtml().selectDocument(new JsoupXpathSelector(&quot;//title/text()&quot;));</span><br><span class="line">        List&lt;String&gt; list = page.getHtml().selectDocumentForList(new JsoupXpathSelector(&quot;//div[@class=&apos;tpc_content do_not_catch&apos;]/descendant::input[@type=&apos;image&apos;]/@src&quot;));</span><br><span class="line">        page.putField(&quot;title&quot;, title);</span><br><span class="line">        page.putField(&quot;images&quot;, list);</span><br><span class="line">        Selectable links = page.getHtml().links();</span><br><span class="line">        List&lt;String&gt; targeturls = links.regex(&quot;http:\\/\\/cl\\.pclmm\\.org\\/htm_data\\/\\d+\\/\\d+\\/\\d+\\.html&quot;).all();</span><br><span class="line">        List&lt;String&gt; helpurls = links.regex(&quot;http:\\/\\/cl\\.pclmm\\.org\\/thread0806\\.php\\?fid=16&amp;search=&amp;page=\\d+&quot;).all();</span><br><span class="line">        page.addTargetRequests(helpurls);</span><br><span class="line">        page.addTargetRequests(targeturls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Site getSite() &#123;</span><br><span class="line">        return site;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws FileNotFoundException, UnsupportedEncodingException &#123;</span><br><span class="line">        Spider.create(new CaoLiuProcessor())</span><br><span class="line">//                .setScheduler(new FileCacheQueueScheduler(&quot;/Users/suclogger/MyWorkspace/caoliua&quot;))</span><br><span class="line">                .addUrl(&quot;http://cl.pclmm.org/thread0806.php?fid=16&amp;search=&amp;page=1&quot;)</span><br><span class="line">                .addPipeline(new CaoLiuPip())</span><br><span class="line">                .thread(2)</span><br><span class="line">                .run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>CaoLiuPip.java:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">public class CaoLiuPip implements Pipeline&#123;</span><br><span class="line">    private final static String path = &quot;/Users/suclogger/MyWorkspace/caoliu/&quot;;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void process(ResultItems resultItems, Task task) &#123;</span><br><span class="line">        String title = resultItems.get(&quot;title&quot;);</span><br><span class="line">        List&lt;String&gt; list = resultItems.get(&quot;images&quot;);</span><br><span class="line">        if(!StringUtils.isBlank(title) &amp;&amp; list.size() &gt; 0) &#123;</span><br><span class="line">            StringBuffer imgFileNameNewYuan =new StringBuffer(path)</span><br><span class="line">                    .append(title) //此处提取文件夹名，即之前采集的标题名</span><br><span class="line">                    .append(&quot;/&quot;);</span><br><span class="line">            //这里先判断文件夹名是否存在，不存在则建立相应文件夹</span><br><span class="line">            Path target = Paths.get(imgFileNameNewYuan.toString());</span><br><span class="line">            if(!Files.isReadable(target))&#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Files.createDirectory(target);</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    logger.error(&quot;folder exist &#123;&#125;&quot;, imgFileNameNewYuan.toString(),e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            for(int i=1;i&lt;list.size();i++)&#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    ThreadPoolFactory.getThreadPool().execute(new DownloadImg(imgFileNameNewYuan.toString(), title,list.get(i)));</span><br><span class="line">                &#125; catch (RejectedExecutionException e) &#123;</span><br><span class="line">                    logger.error(&quot;image thread too many, hold on for a minuet&quot;);</span><br><span class="line">                    try &#123;</span><br><span class="line">                        Thread.sleep(60000);</span><br><span class="line">                        // retry</span><br><span class="line">                        ThreadPoolFactory.getThreadPool().execute(new DownloadImg(imgFileNameNewYuan.toString(), title,list.get(i)));</span><br><span class="line">                    &#125; catch (Exception e1) &#123;</span><br><span class="line">                        logger.error(&quot;shit retry error. do nothing&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class DownloadImg implements Runnable&#123;</span><br><span class="line">        private final HttpHost proxy = new HttpHost(&quot;127.0.0.1&quot;, 6152, &quot;http&quot;);</span><br><span class="line"></span><br><span class="line">        String imgpath;</span><br><span class="line">        String title;</span><br><span class="line">        String link;</span><br><span class="line"></span><br><span class="line">        public DownloadImg(String imgpath, String title, String link) &#123;</span><br><span class="line">            this.imgpath = imgpath;</span><br><span class="line">            this.title = title;</span><br><span class="line">            this.link = link;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                String extName=com.google.common.io</span><br><span class="line">                        .Files.getFileExtension(link);</span><br><span class="line">                StringBuffer imgFileNameNew = new StringBuffer(imgpath)</span><br><span class="line">                        .append((link)</span><br><span class="line">                                .replaceAll(&quot;[\\pP‘’“”]&quot;, &quot;&quot;))</span><br><span class="line">                        .append(&quot;.&quot;)</span><br><span class="line">                        .append(extName);</span><br><span class="line"></span><br><span class="line">                //这里通过httpclient下载之前抓取到的图片网址，并放在对应的文件中</span><br><span class="line">                CloseableHttpClient httpclient = HttpClients.createDefault();</span><br><span class="line">                RequestConfig config = RequestConfig.custom()</span><br><span class="line">                        .setProxy(proxy)</span><br><span class="line">                        .build();</span><br><span class="line">                HttpGet httpget = new HttpGet(link);</span><br><span class="line">                httpget.setConfig(config);</span><br><span class="line">                HttpResponse response = httpclient.execute(httpget);</span><br><span class="line">                HttpEntity entity = response.getEntity();</span><br><span class="line">                InputStream in = entity.getContent();</span><br><span class="line">                File file = new File(imgFileNameNew.toString());</span><br><span class="line">                try &#123;</span><br><span class="line">                    FileOutputStream fout = new FileOutputStream(file);</span><br><span class="line">                    int l = -1;</span><br><span class="line">                    byte[] tmp = new byte[1024];</span><br><span class="line">                    while ((l = in.read(tmp)) != -1) &#123;</span><br><span class="line">                        fout.write(tmp,0,l);</span><br><span class="line">                    &#125;</span><br><span class="line">                    fout.flush();</span><br><span class="line">                    fout.close();</span><br><span class="line">                    logger.info(&quot;save image : &#123;&#125;&quot;, link);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125;</span><br><span class="line">                httpclient.close();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                logger.error(&quot;fail saving image : &#123;&#125;&quot;,link);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="通过注解编写爬虫的例子"><a href="#通过注解编写爬虫的例子" class="headerlink" title="通过注解编写爬虫的例子"></a>通过注解编写爬虫的例子</h2><h3 id="EBookCraw"><a href="#EBookCraw" class="headerlink" title="EBookCraw"></a>EBookCraw</h3><p><code>EBookModel.java</code>（略去了get和set方法）:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">@TargetUrl(&quot;http:\\/\\/www.allitebooks.com\\/(?!read\\/read.php)*&quot;)</span><br><span class="line">@HelpUrl(&#123;&quot;http://www.allitebooks.com/\\/page\\/\\d+&quot;&#125;)</span><br><span class="line">public class EBookModel &#123;</span><br><span class="line">    @ExtractBy(value = &quot;//header[@class=&apos;entry-header&apos;]/h1[@class=&apos;single-title&apos;]/text()&quot;,notNull = true)</span><br><span class="line">    @Formatter(value = &quot;author is %s&quot;,formatter = EBookTitleFormatter.class)</span><br><span class="line">    private String title;</span><br><span class="line"></span><br><span class="line">    @ExtractBy(value = &quot;//header[@class=&apos;entry-header&apos;]/h4/text()&quot;,type = ExtractBy.Type.JsoupXpath)</span><br><span class="line">    private String brief;</span><br><span class="line"></span><br><span class="line">    @ExtractBy(value = &quot;//header[@class=&apos;entry-header&apos;]/div/div[@class*=&apos;entry-body-thumbnail&apos;]/a/img/@src&quot;,type = ExtractBy.Type.JsoupXpath)</span><br><span class="line">    private String cover;</span><br><span class="line"></span><br><span class="line">    @ExtractBy(value = &quot;//div[@class=&apos;book-detail&apos;]/dl/dd[1]/allText()&quot;,type = ExtractBy.Type.JsoupXpath)</span><br><span class="line">    private String author;</span><br><span class="line"></span><br><span class="line">    @ExtractBy(value = &quot;//div[@class=&apos;book-detail&apos;]/dl/dd[2]/allText()&quot;,type = ExtractBy.Type.JsoupXpath)</span><br><span class="line">    private String isbn;</span><br><span class="line"></span><br><span class="line">    @ExtractBy(value = &quot;//div[@class=&apos;book-detail&apos;]/dl/dd[3]/text()&quot;,type = ExtractBy.Type.JsoupXpath)</span><br><span class="line">    private String year;</span><br><span class="line"></span><br><span class="line">    @ExtractBy(value = &quot;//div[@class=&apos;book-detail&apos;]/dl/dd[4]/text()&quot;,type = ExtractBy.Type.JsoupXpath)</span><br><span class="line">    private String pages;</span><br><span class="line"></span><br><span class="line">    @ExtractBy(value = &quot;//div[@class=&apos;book-detail&apos;]/dl/dd[5]/allText()&quot;,type = ExtractBy.Type.JsoupXpath)</span><br><span class="line">    private String language;</span><br><span class="line"></span><br><span class="line">    @ExtractBy(value = &quot;//div[@class=&apos;book-detail&apos;]/dl//dd[6]/allText()&quot;,type = ExtractBy.Type.JsoupXpath)</span><br><span class="line">    private String fileSize;</span><br><span class="line"></span><br><span class="line">    @ExtractBy(value = &quot;//div[@class=&apos;book-detail&apos;]/dl/dd[7]/allText()&quot;,type = ExtractBy.Type.JsoupXpath)</span><br><span class="line">    private String fileFormat;</span><br><span class="line"></span><br><span class="line">    @ExtractBy(value = &quot;//div[@class=&apos;book-detail&apos;]/dl/dd[8]/allText()&quot;,type = ExtractBy.Type.JsoupXpath)</span><br><span class="line">    private String category;</span><br><span class="line"></span><br><span class="line">    @ExtractBy(value = &quot;//div[@class=&apos;entry-content&apos;]/allText()&quot;,type = ExtractBy.Type.JsoupXpath)</span><br><span class="line">    private String description;</span><br><span class="line"></span><br><span class="line">    @ExtractBy(&quot;//span[@class=&apos;download-links&apos;][1]/a/@href&quot;)</span><br><span class="line">    private String downloadLink;</span><br><span class="line"></span><br><span class="line">    @ExtractByUrl(&quot;http://www.allitebooks.com/([\\w-]+)&quot;)</span><br><span class="line">    private String url;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>EBookPip.java:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class EBookPip implements PageModelPipeline &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private EBookAO eBookAO;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void process(Object o, Task task) &#123;</span><br><span class="line">        if(o instanceof EBookModel) &#123;</span><br><span class="line">            EBookModel model = (EBookModel) o;</span><br><span class="line">            EbookDO edo = new EbookDO();</span><br><span class="line">            edo.setTitle(model.getTitle());</span><br><span class="line">            edo.setAuthor(model.getAuthor());</span><br><span class="line">            edo.setBrief(model.getBrief());</span><br><span class="line">            edo.setCategory(model.getCategory());</span><br><span class="line">            edo.setCover(model.getCover());</span><br><span class="line">            edo.setDescription(model.getDescription());</span><br><span class="line">            edo.setDownloadLink(model.getDownloadLink());</span><br><span class="line">            edo.setFileFormat(model.getFileFormat());</span><br><span class="line">            edo.setFileSize(model.getFileSize());</span><br><span class="line">            edo.setIsbn(model.getIsbn());</span><br><span class="line">            edo.setLanguage(model.getLanguage());</span><br><span class="line">            edo.setYears(model.getYear());</span><br><span class="line">            if(!StringUtils.isBlank(model.getPages()) &amp;&amp; StringUtils.isNumeric(model.getPages())) &#123;</span><br><span class="line">                edo.setPages(Integer.valueOf(model.getPages()));</span><br><span class="line">            &#125;</span><br><span class="line">            edo.setUrl(model.getUrl());</span><br><span class="line">            try &#123;</span><br><span class="line">                eBookAO.save(edo);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="对一些特性的分析"><a href="#对一些特性的分析" class="headerlink" title="对一些特性的分析"></a>对一些特性的分析</h2><ul>
<li><p>多线程的支持<br>多线程的支持是通过一个可监控的<code>TheadPool</code>实现的，用法是通过<code>Spider.thread(N)</code>来开启N个线程。</p>
</li>
<li><p>代理的支持<br>下文 <code>应对网站的反爬措施</code> 部分中会展开。</p>
</li>
<li><p>过滤重复URL的支持<br>过滤是通过实现<code>DuplicateRemover</code>接口实现的，默认实现是使用内存中的一个<code>HashSet</code>集来存放已添加进爬取队列的网址。<br>扩展中还添加了<a href="https://zh.wikipedia.org/wiki/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8" target="_blank" rel="noopener">布隆过滤器</a>的实现，适用于巨量网址的去重。</p>
</li>
<li><p>爬取ajax返回信息<br>通过采集页面链接，并将ajax链接放入爬取队列中可以实现。</p>
</li>
<li><p>支持爬取需要登录验证的网页信息（Cookie管理）<br><code>Scrapy</code>替我们托管了所有cookie操作，但是webmagic中没有实现。<br>通过<code>CookieProvider</code>管理Cookie。</p>
</li>
<li><p>持久信息的支持<br>如上面的<code>EBookCraw</code>例子，可以在PipeLine中添加数据持久化逻辑。</p>
</li>
<li><p>支持停止后从断点继续<br>采用<code>FileCacheQueueScheduler</code>来管理爬取链接，爬取中止后可以从文件中读取爬取进度。</p>
</li>
</ul>
<h2 id="应对网站的反爬措施"><a href="#应对网站的反爬措施" class="headerlink" title="应对网站的反爬措施"></a>应对网站的反爬措施</h2><p>主要有下面三个方面 ：</p>
<ol>
<li>使用webmagic集成的<code>ProxyPool</code>来管理Proxy</li>
<li>实现<code>CookieProvider</code>自定义管理Cookie</li>
<li>实现<code>ErrorDetector</code>自定义捕获错误</li>
</ol>
<h3 id="使用webmagic集成的ProxyPool来管理Proxy"><a href="#使用webmagic集成的ProxyPool来管理Proxy" class="headerlink" title="使用webmagic集成的ProxyPool来管理Proxy"></a>使用webmagic集成的<code>ProxyPool</code>来管理Proxy</h3><p><code>ProxyPool</code>维护了一个代理的有序队列，在每次请求完成后，通过请求的状态码设置当前使用的代理的优先级别返还到队列中，每次请求从队列中根据优先级别重新获取新的代理。<br>这种方式适用于手上有很多前向代理资源的爬虫，切换起来比较方便，有些情况下可能需要与切换Cookie相互配合使用。</p>
<h3 id="实现CookieProvider自定义管理Cookie"><a href="#实现CookieProvider自定义管理Cookie" class="headerlink" title="实现CookieProvider自定义管理Cookie"></a>实现<code>CookieProvider</code>自定义管理Cookie</h3><p>每次请求都会从<code>CookieProvider</code>中拿一个cookie放入本次请求头中，可以通过方法调用切换cookie。<br><strong>结合renault演示</strong></p>
<h2 id="增量抓取"><a href="#增量抓取" class="headerlink" title="增量抓取"></a>增量抓取</h2><p>通过实现<code>ExistDetector</code>接口，在抓取后续链接的时候调用<code>detect()</code>方法进行判断是否需要抓取该链接。<br><strong>结合renault演示</strong></p>
<h2 id="爬虫的运行监控"><a href="#爬虫的运行监控" class="headerlink" title="爬虫的运行监控"></a>爬虫的运行监控</h2><p>还在雏形阶段<br><img src="/image/2016-05-20 17-19-29.jpg?r=26" alt></p>
<p>参考：<a href="http://my.oschina.net/flashsword/blog/202889" target="_blank" rel="noopener">WebMagic Avalon设计草图</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/18/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/page/20/">20</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/20/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Suclogger" src="/image/avatar.png">
  <p class="site-author-name" itemprop="name">Suclogger</p>
  <div class="site-description" itemprop="description">人生如逆旅，我亦是行人</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">64</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags">
          
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/suclogger" title="GitHub → https://github.com/suclogger" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Suclogger</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://suclogger.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
