<!DOCTYPE html>






  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="人生如逆旅，我亦是行人">
<meta property="og:type" content="website">
<meta property="og:title" content="Suclogger">
<meta property="og:url" content="https://suclogger.me/page/13/index.html">
<meta property="og:site_name" content="Suclogger">
<meta property="og:description" content="人生如逆旅，我亦是行人">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Suclogger">
<meta name="twitter:description" content="人生如逆旅，我亦是行人">






  <link rel="canonical" href="https://suclogger.me/page/13/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Suclogger</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Suclogger</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">莆放</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">Archives</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories" rel="section">Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about" rel="section">About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">
    <a href="/sitemap.xml" rel="section">Sitemap</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://suclogger.me/Elasticsearch中文社区20160618杭州线下聚会纪要/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Suclogger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Suclogger">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Elasticsearch中文社区20160618杭州线下聚会纪要/" itemprop="url">
                  Elasticsearch中文社区20160618杭州线下聚会纪要
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-06-18 22:56:21" itemprop="dateCreated datePublished" datetime="2016-06-18T22:56:21+08:00">2016-06-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2016-06-26 17:26:30" itemprop="dateModified" datetime="2016-06-26T17:26:30+08:00">2016-06-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/搜索/" itemprop="url" rel="index"><span itemprop="name">搜索</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <!-- abstract -->
<!-- 开始正文 -->
<h2 id="汪兴－Elasticsearch结合hbase的应用"><a href="#汪兴－Elasticsearch结合hbase的应用" class="headerlink" title="汪兴－Elasticsearch结合hbase的应用"></a>汪兴－Elasticsearch结合hbase的应用</h2><p>介绍中使用的存储介质是HBase，我司目前还未达到迁移到NoSQL的数据量级，而且后面的分享中大都采用hadoop（hive，spark）作为mysql数据的全量备份，目前看来参考的价值不大。<br>不过后面也有一些具有参考意义的，比如提到的可以将若干条件作为一组进行分组条件逻辑查询，还涉及到备份方式的讨论，脑裂问题的解决。</p>
<h2 id="万斌－ElasticSearch在gooagoo的实践"><a href="#万斌－ElasticSearch在gooagoo的实践" class="headerlink" title="万斌－ElasticSearch在gooagoo的实践"></a>万斌－ElasticSearch在gooagoo的实践</h2><p>算是对于搜索的另一个方面的应用：数据统计，将传统BI的工作用elasticsearch来实现。<br>提到了Sense插件，可以自动补全查询的json。<br>提到了terms  Aggregation无法精确统计的问题。</p>
<h2 id="曾勇－Introduction-to-Beats-and-extending"><a href="#曾勇－Introduction-to-Beats-and-extending" class="headerlink" title="曾勇－Introduction to Beats and extending"></a>曾勇－Introduction to Beats and extending</h2><p>作为中文鼎鼎大名IK分词器的作者，medcl给我们带来了一个新的产品线Beats系列，是将来能很大程度取代logstash的一个产品，大部分还在开发验证阶段。</p>
<h2 id="洪斌－有赞搜索引擎实践"><a href="#洪斌－有赞搜索引擎实践" class="headerlink" title="洪斌－有赞搜索引擎实践"></a>洪斌－有赞搜索引擎实践</h2><p>是今天干货最多的一个topic了，虽然在量级上不如淘宝，但是设计中需要考虑到的方面基本覆盖到了。<br>印象很深的地方就是很大程度依赖hadoop来全量备份线上数据和进行索引构建。</p>
<ol>
<li>通过监控mysql的binlog，产生消息到kafka，消费消息实时将mysql的事务同步到搜索中。<img src="/image/2016-06-19 00-25-41.jpg" alt=""></li>
<li>商用搜索引擎的AdvancedSearch的概念，将反向代理和通用算法层抽离出来。</li>
<li>提到了评分体系的静态分和动态分的概念，静态分需要稳定和线性，动态分体现搜索的相关度。</li>
<li>商品去重的问题，使用spark进行矢量相似度计算，在搜索时有限搜索去重之后的主库，只在出现召回等情况时搜索辅库。<img src="/image/2016-06-19 00-24-10.jpg" alt=""></li>
<li>店铺去重的问题，通过分bucket的方式，在匹配度高的店铺和匹配度低的店铺中做了折衷。<img src="/image/2016-06-19 00-22-44.jpg" alt=""></li>
<li>Query分析，通过分析搜索日志和购买日志画出query转化图，进行后续的同义词扩展，核心词提取和智能纠错方面的应用。</li>
<li>将搜索输入的关键字转化为不同权重的同义词输入es查询。<img src="/image/2016-06-19 00-21-16.jpg" alt=""></li>
<li>使用rolling技术替代性能很差的分页操作。</li>
<li>优先采用filtered_query。</li>
<li>使用用bulk。 </li>
</ol>
<h2 id="宁海元－基于ELK的云日志产品实践"><a href="#宁海元－基于ELK的云日志产品实践" class="headerlink" title="宁海元－基于ELK的云日志产品实践"></a>宁海元－基于ELK的云日志产品实践</h2><p>主要介绍ELK的日志实现，技术细节不多。</p>
<h2 id="卢栋－elasticsearch-jdbc介绍及基于binlog的增量同步方案"><a href="#卢栋－elasticsearch-jdbc介绍及基于binlog的增量同步方案" class="headerlink" title="卢栋－elasticsearch-jdbc介绍及基于binlog的增量同步方案"></a>卢栋－elasticsearch-jdbc介绍及基于binlog的增量同步方案</h2><p>算是最贴近我司现有起步阶段的topic，介绍了elasticsearch-jdbc的使用。<br>提到了elasticsearch-jdbc使用中的一些痛点，如定时轮询的操作会影响mysql的性能，多数据源配置比较麻烦和sql的增量控制的时间条件不准确，从而提出了通过监听binlog来实现实时同步的方案简单有效，很受启发。<br><img src="/image/2016-06-19 00-31-14.jpg" alt=""><br>还提到了通过alias不停机迁移来做定时的全量，也很受启发。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://suclogger.me/elasticsearch上手指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Suclogger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Suclogger">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/elasticsearch上手指南/" itemprop="url">
                  elasticsearch上手指南
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-06-10 19:09:26" itemprop="dateCreated datePublished" datetime="2016-06-10T19:09:26+08:00">2016-06-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2016-07-28 01:34:21" itemprop="dateModified" datetime="2016-07-28T01:34:21+08:00">2016-07-28</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/搜索/" itemprop="url" rel="index"><span itemprop="name">搜索</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <!-- abstract -->
<!-- 开始正文 -->
<h2 id="CentOS上安装elasticsearch"><a href="#CentOS上安装elasticsearch" class="headerlink" title="CentOS上安装elasticsearch"></a>CentOS上安装elasticsearch</h2><p>首先需要JAVA环境，这里不再详述。<br>在<a href="https://www.elastic.co/downloads/elasticsearch" target="_blank" rel="noopener">官网下载页面</a>找到RMP包的下载路径，通过wget命令下载安装包到本地：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="regexp">//</span>download.elastic.co<span class="regexp">/elasticsearch/</span>release<span class="regexp">/org/</span>elasticsearch<span class="regexp">/distribution/</span>rpm<span class="regexp">/elasticsearch/</span><span class="number">2.3</span>.<span class="number">3</span><span class="regexp">/elasticsearch-2.3.3.rpm</span></span><br></pre></td></tr></table></figure></p>
<p>执行安装<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">sudo</span> <span class="selector-tag">rpm</span> <span class="selector-tag">-ivh</span> <span class="selector-tag">elasticsearch-2</span><span class="selector-class">.3</span><span class="selector-class">.3</span><span class="selector-class">.rpm</span></span><br></pre></td></tr></table></figure></p>
<p>默认安装到<code>/usr/share/elasticsearch/</code>，配置文件在<code>/etc/elasticsearch</code>，init脚本在<code>/etc/init.d/elasticsearch</code>。<br>添加为服务：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="builtin-name">enable</span> elasticsearch.service</span><br></pre></td></tr></table></figure></p>
<p>启动：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="regexp">/etc/i</span>nit.d<span class="regexp">/elasticsearch start</span></span><br></pre></td></tr></table></figure></p>
<p>查看：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">http:</span><span class="comment">//localhost:9200</span></span><br></pre></td></tr></table></figure></p>
<h2 id="创建一个文稿"><a href="#创建一个文稿" class="headerlink" title="创建一个文稿"></a>创建一个文稿</h2><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT 'localhost:<span class="number">9200</span>/<span class="built_in">get</span>-together/<span class="built_in">group</span>/<span class="number">1</span>?pretty' -d '&#123; <span class="string">"name"</span>: <span class="string">"Elasticsearch Denver"</span>, <span class="string">"organizer"</span>: <span class="string">"Lee"</span> &#125;'</span><br></pre></td></tr></table></figure>
<p>可以看到返回信息：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_index"</span> : <span class="string">"get-together"</span>,</span><br><span class="line">  <span class="attr">"_type"</span> : <span class="string">"group"</span>,</span><br><span class="line">  <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"created"</span> : <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Elasticsearch自动添加了<code>get-together</code>索引，并创建了一个到类型<code>group</code>的映射。<br>当然你也可以手动创建一个索引：<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT 'localhost:<span class="number">9200</span>/new-index'</span><br></pre></td></tr></table></figure></p>
<p>Elasticsearch自动将<code>name</code>和<code>organizer</code>检测为<code>string</code>类型，如果你又添加了一个文稿，包含除了<code>name</code>和 <code>organizer</code>的其他字段，Elasticsearch也会自动检测它的类型并添加到映射。<br>可以查看这个映射的详细信息：<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="symbol">'localhost</span>:<span class="number">9200</span>/get-together/_mapping/group?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"get-together"</span> : &#123;</span><br><span class="line">    <span class="string">"mappings"</span> : &#123;</span><br><span class="line">      <span class="string">"group"</span> : &#123;</span><br><span class="line">        <span class="string">"properties"</span> : &#123;</span><br><span class="line">          <span class="string">"name"</span> : &#123;</span><br><span class="line">            <span class="string">"type"</span> : "<span class="type">string</span><span class="string">"</span></span><br><span class="line"><span class="string">          &#125;,</span></span><br><span class="line"><span class="string">          "</span>organizer<span class="string">" : &#123;</span></span><br><span class="line"><span class="string">            "</span><span class="keyword">type</span><span class="string">" : "</span>string<span class="string">"</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="开始搜索"><a href="#开始搜索" class="headerlink" title="开始搜索"></a>开始搜索</h2><p>添加一些示例文稿：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github<span class="selector-class">.com</span>:suclogger/elasticsearch-<span class="keyword">in</span>-action.git</span><br><span class="line">sh elasticsearch-<span class="keyword">in</span>-action/populate.sh</span><br></pre></td></tr></table></figure></p>
<p>这个脚本会重建我们之前创建的<code>get-together</code>索引。<br>一个简单的搜索：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">curl</span> <span class="string">"localhost:9200/get-together/group/_search?q=elasticsearch&amp;fields=name,location&amp;size=1&amp;pretty"</span></span><br></pre></td></tr></table></figure></p>
<p>curl请求的链接中，<code>get-together/group</code>指定了范围：<code>get-together</code>索引下的<code>group</code>类型。<br>常见的关键词格式是：<code>q=name:elasticsearch</code>，这里没有指定group下的某个参数，elasticsearch会默认指定为<code>q=_all:elasticsearch</code>来搜索所有参数字段。<br>也可以通过<code>,</code>分隔来同时搜索多个类型，如：<code>curl &quot;localhost:9200/get-together/group,event/_search?q=elasticsearch&amp;fields=name,location&amp;size=1&amp;pretty&quot;</code>，或者完全忽略类型部分来搜索所有类型：<code>curl &quot;localhost:9200/get-together/_search?q=elasticsearch&amp;fields=name,location&amp;size=1&amp;pretty&quot;</code>。<br>类似的，也可以通过<code>,</code>分隔来同时搜索多个索引，如：<code>curl &quot;localhost:9200/get-together,other-index/_search\ ?q=elasticsearch&amp;pretty&quot;</code>，当然这个请求会失败，因为我们还没创建<code>other-index</code>索引。也可以指定<code>_all</code>来搜索所有索引。<br>返回的结果中：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"took"</span> : <span class="number">5</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hits"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"max_score"</span> : <span class="number">0.83339834</span>,</span><br><span class="line">    <span class="attr">"hits"</span> : [ &#123;</span><br><span class="line">      <span class="attr">"_index"</span> : <span class="string">"get-together"</span>,</span><br><span class="line">      <span class="attr">"_type"</span> : <span class="string">"group"</span>,</span><br><span class="line">      <span class="attr">"_id"</span> : <span class="string">"2"</span>,</span><br><span class="line">      <span class="attr">"_score"</span> : <span class="number">0.83339834</span>,</span><br><span class="line">      <span class="attr">"fields"</span> : &#123;</span><br><span class="line">        <span class="attr">"name"</span> : [ <span class="string">"Elasticsearch Denver"</span> ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>took</code>表示查询耗时5ms，<code>timed_out</code>为false表示查询未超时（默认下查询永远不会超时，可以在curl链接后附带<code>&amp;timeout=3s</code>来指定超时时间为3s）</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://suclogger.me/记一个线上bug的解决/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Suclogger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Suclogger">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/记一个线上bug的解决/" itemprop="url">
                  记一个线上bug的解决
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-05-27 22:56:03" itemprop="dateCreated datePublished" datetime="2016-05-27T22:56:03+08:00">2016-05-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2016-05-30 14:49:39" itemprop="dateModified" datetime="2016-05-30T14:49:39+08:00">2016-05-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">编程</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <!-- abstract -->
<!-- 开始正文 -->
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>我司的爬虫现在运行在一个通过ADSL拨号联网的VPS上，通过重新拨号切换IP来应对目标网站的防爬措施。</p>
<h2 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h2><p>应用通过<a href="https://github.com/alibaba/druid" target="_blank" rel="noopener">druid</a>数据源连接到mysql保存数据，每次切换IP后，会通过下面这条简单sql尝试获取数据源连接：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">'1'</span> <span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure></p>
<p>但是通过查看日志这条sql每次都要等待长达17分钟才能执行完成：<br><img src="/image/3c91ebb0cbc84db0befa2f276df8fa19.jpg?r=59" alt=""></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>数据库的连接是长连接，IP切换之后原先的TCP长连接也都被断开，需要重新获取数据库连接，但是VPS到数据的连接延时稳定在20ms以内，ADSL拨号重建连接的耗时也在2s以内，重建TCP链路不应该耗时17分钟之久：<br>    <img src="/image/2016-05-27 23-28-05.jpg" alt=""></p>
<h3 id="bleedfly猜测mysql服务器可能受到DNS污染。"><a href="#bleedfly猜测mysql服务器可能受到DNS污染。" class="headerlink" title="@bleedfly猜测mysql服务器可能受到DNS污染。"></a><a href="https://twitter.com/bleedfly" target="_blank" rel="noopener">@bleedfly</a>猜测mysql服务器可能受到DNS污染。</h3><p>手动重新拨号之后ping接mysql域名，发现解析正确。<br>通过<code>yum install mysql</code>命令在VPS（CentOS）主机上安装mysql客户端后也可以在拨号之后迅速正常连接到mysql，遂排除这一可能。</p>
<h3 id="尝试根据内存dump文件发现问题"><a href="#尝试根据内存dump文件发现问题" class="headerlink" title="尝试根据内存dump文件发现问题"></a>尝试根据内存dump文件发现问题</h3><p>通过以下命令：<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo jmap -dump:live,<span class="keyword">format</span>=b,<span class="keyword">file</span>=/root/<span class="keyword">log</span>.bin <span class="string">`pgrep java`</span></span><br></pre></td></tr></table></figure></p>
<p>获取内存dump文件，放入<a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener">MAT</a>中分析：</p>
<p><img src="/image/2016-05-28 00-00-55.jpg" alt=""></p>
<p>可以看到停顿时内存的使用量很小，不存在内存泄露的可能。<br>列出的<code>suspect problem</code>中也看只反映了当时内存中主要存活的对象是<code>org.apache.ibatis.session.Configuration</code>。</p>
<h3 id="分析堆栈日志"><a href="#分析堆栈日志" class="headerlink" title="分析堆栈日志"></a>分析堆栈日志</h3><p>通过以下命令：<br><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack `pgrep java` &gt; jstack.log</span><br></pre></td></tr></table></figure></p>
<p>获取方法调用堆栈进行分析。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2016</span>-<span class="number">05</span>-<span class="number">27</span> <span class="number">20</span>:<span class="number">14</span>:<span class="number">56</span></span><br><span class="line">Full thread dump OpenJDK <span class="number">64</span>-Bit Server VM (<span class="number">24.95</span>-b01 mixed mode):</span><br><span class="line"></span><br><span class="line"><span class="string">"Attach Listener"</span> daemon prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b14001000 nid=<span class="number">0</span>x28a2 waiting on condition [<span class="number">0</span>x0000000000000000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">"pool-3-thread-1"</span> prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1af80c0800 nid=<span class="number">0</span>x274b runnable [<span class="number">0</span>x00007f1b02286000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line">	at java<span class="selector-class">.net</span><span class="selector-class">.SocketInputStream</span><span class="selector-class">.socketRead0</span>(Native Method)</span><br><span class="line">	at java<span class="selector-class">.net</span><span class="selector-class">.SocketInputStream</span><span class="selector-class">.read</span>(SocketInputStream<span class="selector-class">.java</span>:<span class="number">152</span>)</span><br><span class="line">	at java<span class="selector-class">.net</span><span class="selector-class">.SocketInputStream</span><span class="selector-class">.read</span>(SocketInputStream<span class="selector-class">.java</span>:<span class="number">122</span>)</span><br><span class="line">	at com<span class="selector-class">.mysql</span><span class="selector-class">.jdbc</span><span class="selector-class">.util</span><span class="selector-class">.ReadAheadInputStream</span><span class="selector-class">.fill</span>(ReadAheadInputStream<span class="selector-class">.java</span>:<span class="number">114</span>)</span><br><span class="line">	at com<span class="selector-class">.mysql</span><span class="selector-class">.jdbc</span><span class="selector-class">.util</span><span class="selector-class">.ReadAheadInputStream</span><span class="selector-class">.readFromUnderlyingStreamIfNecessary</span>(ReadAheadInputStream<span class="selector-class">.java</span>:<span class="number">161</span>)</span><br><span class="line">	at com<span class="selector-class">.mysql</span><span class="selector-class">.jdbc</span><span class="selector-class">.util</span><span class="selector-class">.ReadAheadInputStream</span><span class="selector-class">.read</span>(ReadAheadInputStream<span class="selector-class">.java</span>:<span class="number">189</span>)</span><br><span class="line">	- locked &lt;<span class="number">0</span>x0000000785ce9b80&gt; (<span class="selector-tag">a</span> com<span class="selector-class">.mysql</span><span class="selector-class">.jdbc</span><span class="selector-class">.util</span><span class="selector-class">.ReadAheadInputStream</span>)</span><br><span class="line">	at com<span class="selector-class">.mysql</span><span class="selector-class">.jdbc</span><span class="selector-class">.MysqlIO</span><span class="selector-class">.readFully</span>(MysqlIO<span class="selector-class">.java</span>:<span class="number">2536</span>)</span><br><span class="line">	at com<span class="selector-class">.mysql</span><span class="selector-class">.jdbc</span><span class="selector-class">.MysqlIO</span><span class="selector-class">.reuseAndReadPacket</span>(MysqlIO<span class="selector-class">.java</span>:<span class="number">2989</span>)</span><br><span class="line">	at com<span class="selector-class">.mysql</span><span class="selector-class">.jdbc</span><span class="selector-class">.MysqlIO</span><span class="selector-class">.reuseAndReadPacket</span>(MysqlIO<span class="selector-class">.java</span>:<span class="number">2978</span>)</span><br><span class="line">	at com<span class="selector-class">.mysql</span><span class="selector-class">.jdbc</span><span class="selector-class">.MysqlIO</span><span class="selector-class">.checkErrorPacket</span>(MysqlIO<span class="selector-class">.java</span>:<span class="number">3526</span>)</span><br><span class="line">	at com<span class="selector-class">.mysql</span><span class="selector-class">.jdbc</span><span class="selector-class">.MysqlIO</span><span class="selector-class">.sendCommand</span>(MysqlIO<span class="selector-class">.java</span>:<span class="number">1989</span>)</span><br><span class="line">	at com<span class="selector-class">.mysql</span><span class="selector-class">.jdbc</span><span class="selector-class">.ConnectionImpl</span><span class="selector-class">.pingInternal</span>(ConnectionImpl<span class="selector-class">.java</span>:<span class="number">4051</span>)</span><br><span class="line">	at com<span class="selector-class">.mysql</span><span class="selector-class">.jdbc</span><span class="selector-class">.ConnectionImpl</span><span class="selector-class">.ping</span>(ConnectionImpl<span class="selector-class">.java</span>:<span class="number">4028</span>)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.GeneratedMethodAccessor14</span><span class="selector-class">.invoke</span>(Unknown Source)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.DelegatingMethodAccessorImpl</span><span class="selector-class">.invoke</span>(DelegatingMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">43</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.reflect</span><span class="selector-class">.Method</span><span class="selector-class">.invoke</span>(Method<span class="selector-class">.java</span>:<span class="number">606</span>)</span><br><span class="line">	at com<span class="selector-class">.alibaba</span><span class="selector-class">.druid</span><span class="selector-class">.pool</span><span class="selector-class">.vendor</span><span class="selector-class">.MySqlValidConnectionChecker</span><span class="selector-class">.isValidConnection</span>(MySqlValidConnectionChecker<span class="selector-class">.java</span>:<span class="number">79</span>)</span><br><span class="line">	at com<span class="selector-class">.alibaba</span><span class="selector-class">.druid</span><span class="selector-class">.pool</span><span class="selector-class">.DruidAbstractDataSource</span><span class="selector-class">.testConnectionInternal</span>(DruidAbstractDataSource<span class="selector-class">.java</span>:<span class="number">1166</span>)</span><br><span class="line">	at com<span class="selector-class">.alibaba</span><span class="selector-class">.druid</span><span class="selector-class">.pool</span><span class="selector-class">.DruidDataSource</span><span class="selector-class">.getConnectionDirect</span>(DruidDataSource<span class="selector-class">.java</span>:<span class="number">668</span>)</span><br><span class="line">	at com<span class="selector-class">.alibaba</span><span class="selector-class">.druid</span><span class="selector-class">.pool</span><span class="selector-class">.DruidDataSource</span><span class="selector-class">.getConnection</span>(DruidDataSource<span class="selector-class">.java</span>:<span class="number">628</span>)</span><br><span class="line">	at com<span class="selector-class">.alibaba</span><span class="selector-class">.druid</span><span class="selector-class">.pool</span><span class="selector-class">.DruidDataSource</span><span class="selector-class">.getConnection</span>(DruidDataSource<span class="selector-class">.java</span>:<span class="number">618</span>)</span><br><span class="line">	at com<span class="selector-class">.alibaba</span><span class="selector-class">.druid</span><span class="selector-class">.pool</span><span class="selector-class">.DruidDataSource</span><span class="selector-class">.getConnection</span>(DruidDataSource<span class="selector-class">.java</span>:<span class="number">79</span>)</span><br><span class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.jdbc</span><span class="selector-class">.datasource</span><span class="selector-class">.DataSourceUtils</span><span class="selector-class">.doGetConnection</span>(DataSourceUtils<span class="selector-class">.java</span>:<span class="number">111</span>)</span><br><span class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.jdbc</span><span class="selector-class">.datasource</span><span class="selector-class">.DataSourceUtils</span><span class="selector-class">.getConnection</span>(DataSourceUtils<span class="selector-class">.java</span>:<span class="number">77</span>)</span><br><span class="line">	at org<span class="selector-class">.mybatis</span><span class="selector-class">.spring</span><span class="selector-class">.transaction</span><span class="selector-class">.SpringManagedTransaction</span><span class="selector-class">.openConnection</span>(SpringManagedTransaction<span class="selector-class">.java</span>:<span class="number">83</span>)</span><br><span class="line">	at org<span class="selector-class">.mybatis</span><span class="selector-class">.spring</span><span class="selector-class">.transaction</span><span class="selector-class">.SpringManagedTransaction</span><span class="selector-class">.getConnection</span>(SpringManagedTransaction<span class="selector-class">.java</span>:<span class="number">69</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.executor</span><span class="selector-class">.BaseExecutor</span><span class="selector-class">.getConnection</span>(BaseExecutor<span class="selector-class">.java</span>:<span class="number">271</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.executor</span><span class="selector-class">.SimpleExecutor</span><span class="selector-class">.prepareStatement</span>(SimpleExecutor<span class="selector-class">.java</span>:<span class="number">69</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.executor</span><span class="selector-class">.SimpleExecutor</span><span class="selector-class">.doQuery</span>(SimpleExecutor<span class="selector-class">.java</span>:<span class="number">56</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.executor</span><span class="selector-class">.BaseExecutor</span><span class="selector-class">.queryFromDatabase</span>(BaseExecutor<span class="selector-class">.java</span>:<span class="number">259</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.executor</span><span class="selector-class">.BaseExecutor</span><span class="selector-class">.query</span>(BaseExecutor<span class="selector-class">.java</span>:<span class="number">132</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.executor</span><span class="selector-class">.CachingExecutor</span><span class="selector-class">.query</span>(CachingExecutor<span class="selector-class">.java</span>:<span class="number">105</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.executor</span><span class="selector-class">.CachingExecutor</span><span class="selector-class">.query</span>(CachingExecutor<span class="selector-class">.java</span>:<span class="number">81</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.session</span><span class="selector-class">.defaults</span><span class="selector-class">.DefaultSqlSession</span><span class="selector-class">.selectList</span>(DefaultSqlSession<span class="selector-class">.java</span>:<span class="number">104</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.session</span><span class="selector-class">.defaults</span><span class="selector-class">.DefaultSqlSession</span><span class="selector-class">.selectList</span>(DefaultSqlSession<span class="selector-class">.java</span>:<span class="number">98</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.session</span><span class="selector-class">.defaults</span><span class="selector-class">.DefaultSqlSession</span><span class="selector-class">.selectOne</span>(DefaultSqlSession<span class="selector-class">.java</span>:<span class="number">62</span>)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke0</span>(Native Method)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke</span>(NativeMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">57</span>)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.DelegatingMethodAccessorImpl</span><span class="selector-class">.invoke</span>(DelegatingMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">43</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.reflect</span><span class="selector-class">.Method</span><span class="selector-class">.invoke</span>(Method<span class="selector-class">.java</span>:<span class="number">606</span>)</span><br><span class="line">	at org<span class="selector-class">.mybatis</span><span class="selector-class">.spring</span><span class="selector-class">.SqlSessionTemplate</span><span class="variable">$SqlSessionInterceptor</span>.invoke(SqlSessionTemplate<span class="selector-class">.java</span>:<span class="number">358</span>)</span><br><span class="line">	at com<span class="selector-class">.sun</span><span class="selector-class">.proxy</span>.<span class="variable">$Proxy13</span>.selectOne(Unknown Source)</span><br><span class="line">	at org<span class="selector-class">.mybatis</span><span class="selector-class">.spring</span><span class="selector-class">.SqlSessionTemplate</span><span class="selector-class">.selectOne</span>(SqlSessionTemplate<span class="selector-class">.java</span>:<span class="number">163</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.binding</span><span class="selector-class">.MapperMethod</span><span class="selector-class">.execute</span>(MapperMethod<span class="selector-class">.java</span>:<span class="number">63</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.binding</span><span class="selector-class">.MapperProxy</span><span class="selector-class">.invoke</span>(MapperProxy<span class="selector-class">.java</span>:<span class="number">43</span>)</span><br><span class="line">	at com<span class="selector-class">.sun</span><span class="selector-class">.proxy</span>.<span class="variable">$Proxy27</span>.initCookie(Unknown Source)</span><br><span class="line">	at com<span class="selector-class">.renault</span><span class="selector-class">.cookie</span><span class="selector-class">.manager</span><span class="selector-class">.impl</span><span class="selector-class">.CookieManagerImpl</span><span class="selector-class">.getCookie</span>(CookieManagerImpl<span class="selector-class">.java</span>:<span class="number">127</span>)</span><br><span class="line">	at com<span class="selector-class">.renault</span><span class="selector-class">.core</span><span class="selector-class">.webmagic</span><span class="selector-class">.cookie</span><span class="selector-class">.WcXcCookieProvider</span><span class="selector-class">.getCookie</span>(WcXcCookieProvider<span class="selector-class">.java</span>:<span class="number">40</span>)</span><br><span class="line">	at us<span class="selector-class">.codecraft</span><span class="selector-class">.webmagic</span><span class="selector-class">.downloader</span><span class="selector-class">.HttpClientGenerator</span><span class="selector-class">.generateCookie</span>(HttpClientGenerator<span class="selector-class">.java</span>:<span class="number">92</span>)</span><br><span class="line">	at us<span class="selector-class">.codecraft</span><span class="selector-class">.webmagic</span><span class="selector-class">.downloader</span><span class="selector-class">.HttpClientGenerator</span><span class="selector-class">.generateClient</span>(HttpClientGenerator<span class="selector-class">.java</span>:<span class="number">73</span>)</span><br><span class="line">	at us<span class="selector-class">.codecraft</span><span class="selector-class">.webmagic</span><span class="selector-class">.downloader</span><span class="selector-class">.HttpClientGenerator</span><span class="selector-class">.getClient</span>(HttpClientGenerator<span class="selector-class">.java</span>:<span class="number">45</span>)</span><br><span class="line">	at us<span class="selector-class">.codecraft</span><span class="selector-class">.webmagic</span><span class="selector-class">.downloader</span><span class="selector-class">.HttpClientDownloader</span><span class="selector-class">.getHttpClient</span>(HttpClientDownloader<span class="selector-class">.java</span>:<span class="number">69</span>)</span><br><span class="line">	at us<span class="selector-class">.codecraft</span><span class="selector-class">.webmagic</span><span class="selector-class">.downloader</span><span class="selector-class">.HttpClientDownloader</span><span class="selector-class">.download</span>(HttpClientDownloader<span class="selector-class">.java</span>:<span class="number">97</span>)</span><br><span class="line">	at us<span class="selector-class">.codecraft</span><span class="selector-class">.webmagic</span><span class="selector-class">.Spider</span><span class="selector-class">.processRequest</span>(Spider<span class="selector-class">.java</span>:<span class="number">409</span>)</span><br><span class="line">	at us<span class="selector-class">.codecraft</span><span class="selector-class">.webmagic</span><span class="selector-class">.Spider</span>$<span class="number">1</span>.run(Spider<span class="selector-class">.java</span>:<span class="number">322</span>)</span><br><span class="line">	at us<span class="selector-class">.codecraft</span><span class="selector-class">.webmagic</span><span class="selector-class">.thread</span><span class="selector-class">.CountableThreadPool</span>$<span class="number">1</span>.run(CountableThreadPool<span class="selector-class">.java</span>:<span class="number">74</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1145</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.run(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">615</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">745</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"DestroyJavaVM"</span> prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c00c000 nid=<span class="number">0</span>x2723 waiting on condition [<span class="number">0</span>x0000000000000000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">"pool-2-thread-1"</span> prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c1d2800 nid=<span class="number">0</span>x2743 waiting on condition [<span class="number">0</span>x00007f1b03518000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: WAITING (parking)</span><br><span class="line">	at sun<span class="selector-class">.misc</span><span class="selector-class">.Unsafe</span><span class="selector-class">.park</span>(Native Method)</span><br><span class="line">	- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0</span>x00000007831c9fd8&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.AbstractQueuedSynchronizer</span><span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.LockSupport</span><span class="selector-class">.park</span>(LockSupport<span class="selector-class">.java</span>:<span class="number">186</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.AbstractQueuedSynchronizer</span><span class="variable">$ConditionObject</span>.await(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">2043</span>)</span><br><span class="line">	at us<span class="selector-class">.codecraft</span><span class="selector-class">.webmagic</span><span class="selector-class">.thread</span><span class="selector-class">.CountableThreadPool</span><span class="selector-class">.execute</span>(CountableThreadPool<span class="selector-class">.java</span>:<span class="number">61</span>)</span><br><span class="line">	at us<span class="selector-class">.codecraft</span><span class="selector-class">.webmagic</span><span class="selector-class">.Spider</span><span class="selector-class">.run</span>(Spider<span class="selector-class">.java</span>:<span class="number">318</span>)</span><br><span class="line">	at com<span class="selector-class">.renault</span><span class="selector-class">.core</span><span class="selector-class">.webmagic</span><span class="selector-class">.craw</span><span class="selector-class">.WcXcCrawler</span><span class="selector-class">.crawl</span>(WcXcCrawler<span class="selector-class">.java</span>:<span class="number">66</span>)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke0</span>(Native Method)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke</span>(NativeMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">57</span>)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.DelegatingMethodAccessorImpl</span><span class="selector-class">.invoke</span>(DelegatingMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">43</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.reflect</span><span class="selector-class">.Method</span><span class="selector-class">.invoke</span>(Method<span class="selector-class">.java</span>:<span class="number">606</span>)</span><br><span class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.scheduling</span><span class="selector-class">.support</span><span class="selector-class">.ScheduledMethodRunnable</span><span class="selector-class">.run</span>(ScheduledMethodRunnable<span class="selector-class">.java</span>:<span class="number">65</span>)</span><br><span class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.scheduling</span><span class="selector-class">.support</span><span class="selector-class">.DelegatingErrorHandlingRunnable</span><span class="selector-class">.run</span>(DelegatingErrorHandlingRunnable<span class="selector-class">.java</span>:<span class="number">54</span>)</span><br><span class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.scheduling</span><span class="selector-class">.concurrent</span><span class="selector-class">.ReschedulingRunnable</span><span class="selector-class">.run</span>(ReschedulingRunnable<span class="selector-class">.java</span>:<span class="number">81</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.Executors</span><span class="variable">$RunnableAdapter</span>.call(Executors<span class="selector-class">.java</span>:<span class="number">471</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.FutureTask</span><span class="selector-class">.run</span>(FutureTask<span class="selector-class">.java</span>:<span class="number">262</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ScheduledThreadPoolExecutor</span><span class="variable">$ScheduledFutureTask</span>.access$<span class="number">201</span>(ScheduledThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">178</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ScheduledThreadPoolExecutor</span><span class="variable">$ScheduledFutureTask</span>.run(ScheduledThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">292</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1145</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.run(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">615</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">745</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"commons-pool-EvictionTimer"</span> daemon prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4cb7d000 nid=<span class="number">0</span>x2742 <span class="keyword">in</span> Object.wait() [<span class="number">0</span>x00007f1b034d8000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: TIMED_WAITING (on <span class="selector-tag">object</span> monitor)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Object</span><span class="selector-class">.wait</span>(Native Method)</span><br><span class="line">	- waiting on &lt;<span class="number">0</span>x0000000782824838&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.TaskQueue</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.TimerThread</span><span class="selector-class">.mainLoop</span>(Timer<span class="selector-class">.java</span>:<span class="number">552</span>)</span><br><span class="line">	- locked &lt;<span class="number">0</span>x0000000782824838&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.TaskQueue</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.TimerThread</span><span class="selector-class">.run</span>(Timer<span class="selector-class">.java</span>:<span class="number">505</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"Druid-ConnectionPool-Destory"</span> daemon prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4ca8f000 nid=<span class="number">0</span>x273f waiting on condition [<span class="number">0</span>x00007f1b1804e000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: TIMED_WAITING (sleeping)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.sleep</span>(Native Method)</span><br><span class="line">	at com<span class="selector-class">.alibaba</span><span class="selector-class">.druid</span><span class="selector-class">.pool</span><span class="selector-class">.DruidDataSource</span><span class="variable">$DestroyConnectionThread</span>.run(DruidDataSource<span class="selector-class">.java</span>:<span class="number">1292</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"Druid-ConnectionPool-Create"</span> daemon prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4ca88800 nid=<span class="number">0</span>x273e waiting on condition [<span class="number">0</span>x00007f1b1808f000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: WAITING (parking)</span><br><span class="line">	at sun<span class="selector-class">.misc</span><span class="selector-class">.Unsafe</span><span class="selector-class">.park</span>(Native Method)</span><br><span class="line">	- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0</span>x0000000785a217a8&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.AbstractQueuedSynchronizer</span><span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.LockSupport</span><span class="selector-class">.park</span>(LockSupport<span class="selector-class">.java</span>:<span class="number">186</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.AbstractQueuedSynchronizer</span><span class="variable">$ConditionObject</span>.await(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">2043</span>)</span><br><span class="line">	at com<span class="selector-class">.alibaba</span><span class="selector-class">.druid</span><span class="selector-class">.pool</span><span class="selector-class">.DruidDataSource</span><span class="variable">$CreateConnectionThread</span>.run(DruidDataSource<span class="selector-class">.java</span>:<span class="number">1195</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"Service Thread"</span> daemon prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c1b1800 nid=<span class="number">0</span>x2730 runnable [<span class="number">0</span>x0000000000000000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">"C2 CompilerThread1"</span> daemon prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c1ae800 nid=<span class="number">0</span>x272f waiting on condition [<span class="number">0</span>x0000000000000000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">"C2 CompilerThread0"</span> daemon prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c1ac800 nid=<span class="number">0</span>x272e waiting on condition [<span class="number">0</span>x0000000000000000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">"Signal Dispatcher"</span> daemon prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c1aa000 nid=<span class="number">0</span>x272d runnable [<span class="number">0</span>x0000000000000000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">"Surrogate Locker Thread (Concurrent GC)"</span> daemon prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c1a8000 nid=<span class="number">0</span>x272c waiting on condition [<span class="number">0</span>x0000000000000000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">"Finalizer"</span> daemon prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c17b800 nid=<span class="number">0</span>x272b <span class="keyword">in</span> Object.wait() [<span class="number">0</span>x00007f1b4854b000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: WAITING (on <span class="selector-tag">object</span> monitor)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Object</span><span class="selector-class">.wait</span>(Native Method)</span><br><span class="line">	- waiting on &lt;<span class="number">0</span>x0000000785a217c0&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.lang</span><span class="selector-class">.ref</span><span class="selector-class">.ReferenceQueue</span><span class="variable">$Lock</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ref</span><span class="selector-class">.ReferenceQueue</span><span class="selector-class">.remove</span>(ReferenceQueue<span class="selector-class">.java</span>:<span class="number">135</span>)</span><br><span class="line">	- locked &lt;<span class="number">0</span>x0000000785a217c0&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.lang</span><span class="selector-class">.ref</span><span class="selector-class">.ReferenceQueue</span><span class="variable">$Lock</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ref</span><span class="selector-class">.ReferenceQueue</span><span class="selector-class">.remove</span>(ReferenceQueue<span class="selector-class">.java</span>:<span class="number">151</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ref</span><span class="selector-class">.Finalizer</span><span class="variable">$FinalizerThread</span>.run(Finalizer<span class="selector-class">.java</span>:<span class="number">209</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"Reference Handler"</span> daemon prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c179800 nid=<span class="number">0</span>x272a <span class="keyword">in</span> Object.wait() [<span class="number">0</span>x00007f1b50078000]</span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: WAITING (on <span class="selector-tag">object</span> monitor)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Object</span><span class="selector-class">.wait</span>(Native Method)</span><br><span class="line">	- waiting on &lt;<span class="number">0</span>x0000000785a217f0&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.lang</span><span class="selector-class">.ref</span><span class="selector-class">.Reference</span><span class="variable">$Lock</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Object</span><span class="selector-class">.wait</span>(Object<span class="selector-class">.java</span>:<span class="number">503</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ref</span><span class="selector-class">.Reference</span><span class="variable">$ReferenceHandler</span>.run(Reference<span class="selector-class">.java</span>:<span class="number">133</span>)</span><br><span class="line">	- locked &lt;<span class="number">0</span>x0000000785a217f0&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.lang</span><span class="selector-class">.ref</span><span class="selector-class">.Reference</span><span class="variable">$Lock</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"VM Thread"</span> prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c175000 nid=<span class="number">0</span>x2729 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">"Gang worker#0 (Parallel GC Threads)"</span> prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c01d800 nid=<span class="number">0</span>x2724 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">"Gang worker#1 (Parallel GC Threads)"</span> prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c01f800 nid=<span class="number">0</span>x2725 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">"Gang worker#2 (Parallel GC Threads)"</span> prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c021000 nid=<span class="number">0</span>x2726 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">"Gang worker#3 (Parallel GC Threads)"</span> prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c023000 nid=<span class="number">0</span>x2727 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">"Concurrent Mark-Sweep GC Thread"</span> prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c0a3800 nid=<span class="number">0</span>x2728 runnable </span><br><span class="line"><span class="string">"VM Periodic Task Thread"</span> prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f1b4c1bc800 nid=<span class="number">0</span>x2731 waiting on condition </span><br><span class="line"></span><br><span class="line">JNI global references: <span class="number">150</span></span><br></pre></td></tr></table></figure></p>
<p>排除了标明为<code>RUNNABLE</code>的线程之后，首先寻找是否有处于<code>Deadlock</code>状态的线程。<br>没有发现Deadlock，如果有可能等待时间就不止17分钟了。</p>
<p>接下来罗列处于<code>WAITING</code>状态的线程：</p>
<ol>
<li>“pool-2-thread-1” prio=10 tid=0x00007f1b4c1d2800 nid=0x2743 waiting on condition [0x00007f1b03518000] java.lang.Thread.State: WAITING (parking)</li>
<li>“commons-pool-EvictionTimer” daemon prio=10 tid=0x00007f1b4cb7d000 nid=0x2742 in Object.wait() [0x00007f1b034d8000] java.lang.Thread.State: TIMED_WAITING (on object monitor)</li>
<li>“Druid-ConnectionPool-Destory” daemon prio=10 tid=0x00007f1b4ca8f000 nid=0x273f waiting on condition [0x00007f1b1804e000] java.lang.Thread.State: TIMED_WAITING (sleeping)</li>
<li>“Druid-ConnectionPool-Create” daemon prio=10 tid=0x00007f1b4ca88800 nid=0x273e waiting on condition [0x00007f1b1808f000] java.lang.Thread.State: WAITING (parking)</li>
<li>“Finalizer” daemon prio=10 tid=0x00007f1b4c17b800 nid=0x272b in Object.wait() [0x00007f1b4854b000]  java.lang.Thread.State: WAITING (on object monitor)</li>
<li>“Reference Handler” daemon prio=10 tid=0x00007f1b4c179800 nid=0x272a in Object.wait() [0x00007f1b50078000]  java.lang.Thread.State: WAITING (on object monitor)</li>
</ol>
<p>其中，第2个：”commons-pool-EvictionTimer” 用于空闲对象的驱逐，第5个：”Finalizer”线程用于在垃圾收集前，调用对象的finalize()方法，第6个：”Reference Handler”用于处理引用对象本身（软引用、弱引用、虚引用）的垃圾回收问题 ，这3个线程都从属于JVM，暂时忽略。</p>
<p>粗略看来剩下的3个线程中，第1个和第4个都处于<code>WAITING (parking)</code>的状态，即依赖于<code>特定condition</code>的发生，而第3个处于<code>TIMED_WAITING (sleeping)</code>，很可能是方法调用了Thread.wait()或者Thread.sleep()。</p>
<p>查看pom文件，找到版本号<code>0.2.9</code>，在druid目录通过check out到对应版本号的tag定位源代码：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DestroyConnectionThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    public <span class="type">DestroyConnectionThread</span>(<span class="type">String</span> name)&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">        <span class="keyword">this</span>.setDaemon(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void run() &#123;</span><br><span class="line">        initedLatch.countDown();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// 从前面开始删除</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (timeBetweenEvictionRunsMillis &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">Thread</span>.sleep(timeBetweenEvictionRunsMillis);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">Thread</span>.sleep(<span class="number">1000</span>); <span class="comment">// 这里是1292行</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="type">Thread</span>.interrupted()) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                shrink(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (isRemoveAbandoned()) &#123;</span><br><span class="line">                    removeAbandoned();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="type">InterruptedException</span> e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的代码逻辑是这个独立的线程是用于回收关闭的链接，由于run方法一开始已经调用了<code>initedLatch.countDown();</code>，应该不会影响主线程，所以第3个线程也不是罪魁祸首。</p>
<p>找来找去，怀疑的目光又落在了<code>pool-3-thread-1</code>这个最早看来人畜无害的<code>Runable</code>线程。<br>猛烈google之后，发现了相关的讨论：<a href="https://bugs.mysql.com/bug.php?id=9515" target="_blank" rel="noopener">Long response waiting using Connector</a></p>
<blockquote>
<p>always close the connection and use Socket.setSoTimeout(int) on every connection, I solve my problem. the hanging does never appear again.</p>
</blockquote>
<p>又返回去看druid的源码，发现方法调用堆栈中<code>isValidConnection</code>是支持设置超时时间的，需要在<code>DruidDataSource</code>实例化时作为参数传入。</p>
<h2 id="尝试"><a href="#尝试" class="headerlink" title="尝试"></a>尝试</h2><p>修改xml配置，给<code>datasource</code>的bean中加上下列配置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;property <span class="attribute">name</span>=<span class="string">"validationQueryTimeout"</span> <span class="attribute">value</span>=<span class="string">"1000"</span>/&gt;</span><br></pre></td></tr></table></figure></p>
<p>但是实际发现没有起作用，底层的socket连接依然在等待。又发现druid最新版本（1.0.20）中已经给<code>validationQueryTimeout</code>设置了默认值<code>1000ms</code>，尝试更新druid，最新版依然存在问题。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>又认真想了一遍。<br>druid通过<code>MySqlValidConnectionChecker</code>调用<code>com.mysql.jdbc.ConnectionImpl.pingInternal(boolean checkForClosedConnection, int timeoutMillis)</code>方法，并将validationQueryTimeout作为它的超时值。</p>
<p>druid作为一个datasource pool，不管是选择在收回connection到pool的时候检验connection，还是从poll拿connection的时候检验connection，选择信任<code>pingInternal()</code>方法是无可厚非的。</p>
<p>那锅是要由JDBC的驱动里面的<code>pingInternal()</code>方法来背吗？也不尽然：<a href="https://bugs.mysql.com/bug.php?id=31353" target="_blank" rel="noopener">mysq上的讨论</a></p>
<blockquote>
<p><em>Socket timeouts</em>:<br>UNCLOSED socket connection; JVM specs tell us GC does NOT release these resources thus they exhaust JVM resources related to socket operation, leading to SocketInputStream hanging your program. Always close the connection and use Socket.setSoTimeout(int) on every connection.</p>
</blockquote>
<blockquote>
<p>Now this is in relation with <em>pooled connections</em> and DBCP (or “why does 1.2.1 work”, from Bug#30990):<br>If you’re using a connection pool that <em>doesn’t</em> use the ConnectionPoolDataSource API to create connections that have lifecycle callbacks, then it is the <em>pool’s</em> responsibility to cleanup “logical” pooled connections when they’re returned to the pool. Otherwise there is no way for a JDBC driver to tell that a connection is being pooled “above” it, and thus no event/method call where one can hook in to determine that you’ve been “logically” closed and returned to the pool.<br>More recent version of DBCP automatically call rollback() on connections that are returned to the pool.</p>
</blockquote>
<p>所以，如果我们还想继续使用druid，还是老老实实在重新切换IP断网之前，调用一下<code>DruidDataDource.close()</code>方法显式地关闭connection好了。</p>
<p>其实刚开始我们就通过将数据源切换到<code>DriverManagerDataSource</code>已经歪打正着解决了问题，但是<code>DriverManagerDataSource</code>不是一个连接池，每次都要重新创建connection，所以既然定位了问题，还是用druid更为优雅一些。</p>
<p>解决后可以实现切换动作在1s内完成。<br><img src="/image/2016-05-30 14-17-50.jpg" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/12/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/14/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Suclogger</p>
              <p class="site-description motion-element" itemprop="description">人生如逆旅，我亦是行人</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">48</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">29</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Suclogger</span>

  

  
</div>


  



  <div class="powered-by">Powered by <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" rel="external nofollow" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  



	





  





  










  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

  

</body>
</html>
